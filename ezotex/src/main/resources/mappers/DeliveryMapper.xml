<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ezotex.delivery.mappers.DeliveryMapper">


	<select id="findAll" resultType="ProductDeliveryDTO" parameterType="int">
		WITH order_data AS (
		    SELECT /*+ INDEX_DESC(m PK_ORDER_LIST) */
		           ROWNUM rn,
		           m.product_order_code,
		           m.company_code,
		           m.company,
		           product_summary('order_product', product_order_code) AS summary,
		           m.order_status,
		           m.charger,
		           m.order_date,
		           m.delivery_request_deadline,
		           m.amount
		    FROM order_list m
		    WHERE m.amount BETWEEN NVL(null, m.amount) AND NVL(null, m.amount) --가격 합계 조건
		    AND   ROWNUM <![CDATA[ <= ]]> #{cri.end}
		)
		, delivery_data AS (
		    SELECT s.product_order_code,
		           s.delivery_code AS delivery_code,
		           s.charger_name AS charger_name
		    FROM delivery s 
		    WHERE (s.delivery_code LIKE '%' || NVL(null, s.delivery_code) || '%' OR s.delivery_code IS NULL)
		      AND (s.charger_name LIKE '%' || NVL(null, s.charger_name) || '%' OR s.charger_name IS NULL)
		      AND NOT EXISTS (SELECT delivery_code FROM packing)    --포장되기 전 데이터만 가져오기
		)
		    SELECT od.rn,
		           od.product_order_code,
		           NVL(dd.delivery_code, '미배정') AS delivery_code,
		           od.company_code,
		           od.company,
		           od.summary,
		           get_comm(od.order_status) AS order_status,
		           NVL(dd.charger_name, '미배정') AS charger_name,
		           od.order_date,
		           od.delivery_request_deadline AS dedt
		    FROM order_data od LEFT JOIN delivery_data dd 
		                              ON od.product_order_code = dd.product_order_code
		    WHERE od.product_order_code LIKE '%' || NVL(null, od.product_order_code) || '%'
		      AND od.company_code LIKE '%' || NVL(null, od.company_code) || '%'
		      AND od.company LIKE '%' || NVL(null, od.company) || '%'
		      AND od.order_status = NVL(null, od.order_status)
		      AND od.order_date BETWEEN NVL(null, od.order_date) AND NVL(null, od.order_date)
		      AND od.delivery_request_deadline BETWEEN NVL(null, od.delivery_request_deadline) AND NVL(null, od.delivery_request_deadline)
		      AND od.rn <![CDATA[ >= ]]>#{cri.start}
		    ORDER BY od.product_order_code DESC
	</select>
	
	<select id="getCount" resultType="int">
		WITH order_data AS (
		    SELECT /*+ INDEX_DESC(m PK_ORDER_LIST) */
		           ROWNUM rn,
		           m.product_order_code,
		           m.company_code,
		           m.company,
		           product_summary('order_product', product_order_code) AS summary,
		           m.order_status,
		           m.charger,
		           m.order_date,
		           m.delivery_request_deadline,
		           m.amount
		    FROM order_list m
		    WHERE m.amount BETWEEN NVL(null, m.amount) AND NVL(null, m.amount) --가격 합계 조건
		)
		, delivery_data AS (
		    SELECT s.product_order_code,
		           s.delivery_code AS delivery_code,
		           s.charger_name AS charger_name
		    FROM delivery s 
		    WHERE (s.delivery_code LIKE '%' || NVL(null, s.delivery_code) || '%' OR s.delivery_code IS NULL)
		      AND (s.charger_name LIKE '%' || NVL(null, s.charger_name) || '%' OR s.charger_name IS NULL)
		      AND NOT EXISTS (SELECT delivery_code FROM packing)    --포장되기 전 데이터만 가져오기
		)
	    SELECT count(*)
	    FROM order_data od LEFT JOIN delivery_data dd 
	                              ON od.product_order_code = dd.product_order_code
	    WHERE od.product_order_code LIKE '%' || NVL(null, od.product_order_code) || '%'
	      AND od.company_code LIKE '%' || NVL(null, od.company_code) || '%'
	      AND od.company LIKE '%' || NVL(null, od.company) || '%'
	      AND od.order_status = NVL(null, od.order_status)
	      AND od.order_date BETWEEN NVL(null, od.order_date) AND NVL(null, od.order_date)
	      AND od.delivery_request_deadline BETWEEN NVL(null, od.delivery_request_deadline) AND NVL(null, od.delivery_request_deadline)
	    ORDER BY od.product_order_code DESC
	</select>
</mapper>