<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layouts/layout}" layout:fragment="content">
<head>
<meta charset="UTF-8">
<title>이조텍스SCM</title>
<link rel="stylesheet"
	href="https://uicdn.toast.com/grid/latest/tui-grid.css" />
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://uicdn.toast.com/grid/latest/tui-grid.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
	<h3 class="fs-3 fw-bold">| 손실액 조회</h3>
	<div class="card card-body mt-3 bg-secondary">
		<h3>검색</h3>
		<table class="table mt-3">
			<tbody>
				<!-- 첫 번째 줄 -->
				<tr>
					<td class="col-auto"><label class="col-form-label">제품명</label></td>
					<td class="col-auto"><input type="text" id="productName"
						class="form-control"></td>
					<td class="col-auto"><label class="col-form-label">주문일</label></td>
					<td class="col-auto"><input type="date" id="startOrderDate"
						class="form-control"></td>
					<td>~</td>
					<td class="col-auto"><input type="date" id="endOrderDate"
						class="form-control"></td>
				</tr>
				<!-- 두 번째 줄 -->
				<tr>
					<td class="col-auto"><label class="col-form-label">매출액</label></td>
					<td class="col-auto"><input type="text" id="startTotalSales"
						class="form-control"></td>
					<td>~</td>
					<td class="col-auto"><input type="date" id="endTotalSales"
						class="form-control"></td>
					<td class="col-auto"><label class="col-form-label">손실액</label></td>
					<td class="col-auto"><input type="text" id="startTotalLoss"
						class="form-control"></td>
					<td>~</td>
					<td class="col-auto"><input type="text" id="endTotalLoss"
						class="form-control"></td>

				</tr>
				<!-- 세번째 줄 -->
				<tr>
					<td class="col-auto"><label class="col-form-label">주문수량</label></td>
					<td class="col-auto"><input type="text"
						id="startTotalOrderQuantity" class="form-control"></td>
					<td>~</td>
					<td class="col-auto"><input type="text"
						id="endTotalOrderQuantity" class="form-control"></td>
					<td class="col-auto"><label class="col-form-label">반품수량</label></td>
					<td class="col-auto"><input type="text"
						id="startTotalReturnQuantity" class="form-control"></td>
					<td>~</td>
					<td class="col-auto"><input type="text"
						id="endTotalReturnQuantity" class="form-control"></td>
				</tr>
			</tbody>
		</table>
		<div class="text-center mt-3">
			<button class="btn btn-warning mag-glass-btn"
				onclick="searchSalesLossAmount()">
				<i class="fa-solid fa-magnifying-glass icon-left"
					style="color: #ffffff;"></i>
			</button>
			<button class="btn btn-secondary mag-glass-btn"
				onclick="resetCondition()">
				<i class="fa-solid fa-repeat icon-left" style="color: #ffffff;"></i>
			</button>
		</div>

	</div>

	<!-- 제품 손실액 조회할 그리드 -->
	<!-- 제품 손실액 조회할 그리드 -->
	<div class="card card-body mt-3">
		<h3>제품별 일일 손실액</h3>
		<div id="salesAmountGrid"></div>
		<div class="card-body">
			<div class="d-sm-flex justify-content-between align-items-start">
				<div>
					<h4 class="card-title card-title-dash">제품별 매출·손실 현황</h4>
				</div>
			</div>
			<div class="d-flex flex-row mt-3">
				<!-- 기존 매출액과 손실액 차트 -->
				<div class="chartjs-bar-wrapper"
					style="width: 50%; padding-right: 15px;">
					<canvas id="salesLossAmount" width="300" height="300"
						style="display: block; width: 100%; height: 300px;"
						class="chartjs-render-monitor"></canvas>
				</div>
				<!-- 주문량과 반품량 차트 추가 -->
				<div class="chartjs-bar-wrapper"
					style="width: 50%; padding-left: 15px;">
					<canvas id="orderReturn" width="300" height="300"
						style="display: block; width: 100%; height: 300px;"
						class="chartjs-render-monitor"></canvas>
				</div>
			</div>
		</div>
	</div>

	<script>
	if ($("#salesLossAmount").length) {
	    var salesLossAmountChart = document.getElementById("salesLossAmount").getContext('2d');
	    var salesLossAmountData = {
	        labels: ["금액"],  // 하나의 항목으로 합쳐서 "금액"만 표시
	        datasets: [
	            {
	                label: "매출액",  // 매출액을 먼저 표시
	                data: [],  // 매출액 데이터만 표시
	                backgroundColor: "#52CDFF",  // 매출액 색상
	                borderColor: "#52CDFF",  // 매출액 테두리 색상
	                borderWidth: 1,
	                type: "bar",  // 막대 그래프
	                yAxisID: "y-axis-1"  // 금액은 왼쪽 축 사용
	            },
	            {
	                label: "손실액",  // 손실액을 두 번째로 표시
	                data: [],  // 손실액 데이터만 표시
	                backgroundColor: "#FF5A5A",  // 손실액 색상
	                borderColor: "#FF5A5A",  // 손실액 테두리 색상
	                borderWidth: 1,
	                type: "bar",  // 막대 그래프
	                yAxisID: "y-axis-1"  // 금액은 왼쪽 축 사용
	            }
	        ]
	    };

	    var salesLossAmountOptions = {
	        responsive: true,
	        maintainAspectRatio: false,
	        scales: {
	            yAxes: [{
	                id: 'y-axis-1',
	                position: 'left',
	                ticks: {
	                    beginAtZero: true,
	                    fontSize: 10,
	                    color: "#6B778C",
	                    callback: function(value) {
	                        return value.toLocaleString();  // 금액을 통화 형식으로 표시
	                    }
	                },
	                scaleLabel: {
	                    display: true,
	                    labelString: '금액 (₩)'
	                }
	            }],
	            xAxes: [{
	                stacked: true,
	                barPercentage: 0.35,
	                gridLines: {
	                    display: false,
	                    drawBorder: false,
	                },
	                ticks: {
	                    beginAtZero: false,
	                    autoSkip: true,
	                    maxTicksLimit: 12,
	                    fontSize: 10,
	                    color: "#6B778C"
	                }
	            }]
	        },
	        legend: {
	            display: true  // 범례를 표시
	        },
	        tooltips: {
	            backgroundColor: 'rgba(31, 59, 179, 1)',
	        }
	    };

	    var salesLossAmount = new Chart(salesLossAmountChart, {
	        type: 'bar',
	        data: salesLossAmountData,
	        options: salesLossAmountOptions
	    });
	}
	
	if ($("#orderReturn").length) {
	    var orderReturnChart = document.getElementById("orderReturn").getContext('2d');
	    var orderReturnData = {
	        labels: ["수량"],  // 하나의 항목으로 합쳐서 "금액"만 표시
	        datasets: [
	            {
	                label: "주문량",  // 매출액을 먼저 표시
	                data: [],  // 매출액 데이터만 표시
	                backgroundColor: "#28A745",  // 매출액 색상
	                borderColor: "#28A745",  // 매출액 테두리 색상
	                borderWidth: 1,
	                type: "bar",  // 막대 그래프
	                yAxisID: "y-axis-1"  // 금액은 왼쪽 축 사용
	            },
	            {
	                label: "반품량",  // 손실액을 두 번째로 표시
	                data: [],  // 손실액 데이터만 표시
	                backgroundColor: "#FFA500",  // 손실액 색상
	                borderColor: "#FFA500",  // 손실액 테두리 색상
	                borderWidth: 1,
	                type: "bar",  // 막대 그래프
	                yAxisID: "y-axis-1"  // 금액은 왼쪽 축 사용
	            }
	        ]
	    };

	    var orderReturnOptions = {
	        responsive: true,
	        maintainAspectRatio: false,
	        scales: {
	            yAxes: [{
	                id: 'y-axis-1',
	                position: 'left',
	                ticks: {
	                    beginAtZero: true,
	                    fontSize: 10,
	                    color: "#6B778C",
	                    callback: function(value) {
	                        return value.toLocaleString();
	                    }
	                },
	                scaleLabel: {
	                    display: true,
	                    labelString: '수량'
	                }
	            }],
	            xAxes: [{
	                stacked: true,
	                barPercentage: 0.35,
	                gridLines: {
	                    display: false,
	                    drawBorder: false,
	                },
	                ticks: {
	                    beginAtZero: false,
	                    autoSkip: true,
	                    maxTicksLimit: 12,
	                    fontSize: 10,
	                    color: "#6B778C"
	                }
	            }]
	        },
	        legend: {
	            display: true  // 범례를 표시
	        },
	        tooltips: {
	            backgroundColor: 'rgba(31, 59, 179, 1)',
	        }
	    };

	    var orderReturn = new Chart(orderReturnChart, {
	        type: 'bar',
	        data: orderReturnData,
	        options: orderReturnOptions
	    });
	}
	</script>
	<script th:inline="javascript">
	<!-- 그리드에 넣어줄 데이터 -->
	const salesAmountList = /*[[${getSalesAmount}]]*/[];
	
	// 매출액 + 손실액
	const salesAmountGrid = new tui.Grid({
		el : document.getElementById('salesAmountGrid'),
		scrollX : false, // 가로 스크롤바 비활성화
		scrollY : false, // 세로 스크롤바 비활성화
		data : salesAmountList,
		bodyHeight : 200,
		rowHeaders : [{
			type : 'rowNum',
			header : 'NO'
		}],
		columns : [{
			header : '주문일',
			name : 'orderDate',
			align : 'center',
		},{
			header : '제품명',
			name : 'productName',
			align : 'center',
		},{
			header : '매출액',
			name : 'totalSales',
			align : 'right',
	        formatter: function({ value }) {
	            return value ? value.toLocaleString() : '0';
	        },
		},{
			header : '손실액',
			name : 'totalLoss',
			align : 'right',
	        formatter: function({ value }) {
	            return value ? value.toLocaleString() : '0';
	        },
		},{
			header : '주문량',
			name : 'totalOrderQuantity',
			align : 'right',
	        formatter: function({ value }) {
	            return value ? value.toLocaleString() : '0';
	        },
		},{
			header : '반품량',
			name : 'totalReturnQuantity',
			align : 'right',
	        formatter: function({ value }) {
	            return value ? value.toLocaleString() : '0';
	        },
		}],
	    pageOptions: {
	        useClient: true, // 페이징을 위해 필요
	        perPage: 5
      	},
	})
	
	// 클릭된 행의 데이터를 차트에 반영하는 함수
	function updateChart(rowData) {
	    if (!rowData) return;
	
	    // 새로운 데이터로 업데이트
	    salesLossAmount.data.labels = ["금액"];  // 하나의 항목으로 합쳐서 "금액"을 표시
	    
	    // datasets에서 매출액을 먼저, 손실액을 두 번째로 표시
	    salesLossAmount.data.datasets = [
	        {
	            label: rowData.productName + " 매출액",  // 매출액 라벨
	            data: [rowData.totalSales],  // 매출액만 표시하고
	            backgroundColor: "#52CDFF",  // 매출액 색상
	            borderColor: "#52CDFF",  // 매출액 테두리 색상
	            borderWidth: 1,
	            type: "bar",  // 막대 그래프
	            yAxisID: "y-axis-1",  // 금액은 왼쪽 축 사용
	        },
	        {
	            label: rowData.productName + " 손실액",  // 손실액 라벨
	            data: [rowData.totalLoss],  // 손실액만 표시하고
	            backgroundColor: "#FF5A5A",  // 손실액 색상
	            borderColor: "#FF5A5A",  // 손실액 테두리 색상
	            borderWidth: 1,
	            type: "bar",  // 막대 그래프
	            yAxisID: "y-axis-1",  // 금액은 왼쪽 축 사용
	        }
	    ];
	
	    // 차트 다시 그리기
	    salesLossAmount.update();
	}
	
	function updateOrderReturnChart(rowData) {
	    if (!rowData) return;

	    // 새로운 데이터로 업데이트
	    orderReturn.data.labels = ["수량"];  // 하나의 항목으로 합쳐서 "수량"을 표시
	    
	    // datasets에서 주문량을 먼저, 반품량을 두 번째로 표시
	    orderReturn.data.datasets = [
	        {
	            label: rowData.productName + " 주문량",  // 주문량 라벨
	            data: [rowData.totalOrderQuantity],  // 주문량만 표시하고
	            backgroundColor: "#28A745",  // 주문량 색상
	            borderColor: "#28A745",  // 주문량 테두리 색상
	            borderWidth: 1,
	            type: "bar",  // 막대 그래프
	            yAxisID: "y-axis-1",  // 수량은 왼쪽 축 사용
	        },
	        {
	            label: rowData.productName + " 반품량",  // 반품량 라벨
	            data: [rowData.totalReturnQuantity],  // 반품량만 표시하고
	            backgroundColor: "#FFA500",  // 반품량 색상
	            borderColor: "#FFA500",  // 반품량 테두리 색상
	            borderWidth: 1,
	            type: "bar",  // 막대 그래프
	            yAxisID: "y-axis-1",  // 수량은 왼쪽 축 사용
	        }
	    ];

	    // 차트 다시 그리기
	    orderReturn.update();
	}

	// 그리드 행 클릭 이벤트
	salesAmountGrid.on('click', (ev) => {
	    salesAmountGrid.removeRowClassName(lastClicked, 'bg-blue'); // 이전 선택 행 배경색 제거
	    salesAmountGrid.addRowClassName(ev.rowKey, 'bg-blue'); // 선택된 행 배경색 추가
	    lastClicked = ev.rowKey; // 현재 클릭된 행 저장

	    const rowData = salesAmountGrid.getRow(ev.rowKey);
	    if (rowData) {
	        updateChart(rowData); // 매출액 , 손실액 차트 업데이트
	        updateOrderReturnChart(rowData);  // 주문량, 반품량 차트 업데이트
	    }
	});
	
	let lastClicked = null; // 페이지 이동 시에도 이전 선택 기억하기 위함.
	// 행 클릭 이벤트 추가
	salesAmountGrid.on('click', (ev) => {
		
		salesAmountGrid.removeRowClassName(lastClicked, 'bg-blue'); // 이전 선택 행 배경색 삭제
		salesAmountGrid.addRowClassName(ev.rowKey, 'bg-blue'); // 선택된 행 배경색 추가
	    lastClicked = ev.rowKey; // 선택된 행 기억
	    
	    const rowData = salesAmountGrid.getRow(ev.rowKey);
	    if (rowData) {
	        updateChart(rowData);
	    }
	});
	
	// 손실액 검색 함수
	function searchSalesLossAmount() {
        const productName = document.querySelector('#productName').value;
        const startOrderDate = document.querySelector('#startOrderDate').value;
        const endOrderDate = document.querySelector('#endOrderDate').value;
        const startTotalSales = document.querySelector('#startTotalSales').value;
        const endTotalSales = document.querySelector('#endTotalSales').value;
        const startTotalLoss = document.querySelector('#startTotalLoss').value;
        const endTotalLoss = document.querySelector('#endTotalLoss').value;
        const startTotalOrderQuantity = document.querySelector('#startTotalOrderQuantity').value;
        const endTotalOrderQuantity = document.querySelector('#endTotalOrderQuantity').value;
        const startTotalReturnQuantity = document.querySelector('#startTotalReturnQuantity').value;
        const endTotalReturnQuantity = document.querySelector('#endTotalReturnQuantity').value;
        
        const filteredData = salesAmountList.filter(item => {
            return (!productName || item.productName.includes(productName)) &&
                   (!startOrderDate || item.orderDate >= startOrderDate) &&
                   (!endOrderDate || item.orderDate <= endOrderDate) &&
                   (!startTotalSales || item.totalSales >= startTotalSales) &&
                   (!endTotalSales || item.totalSales <= endTotalSales) &&
                   (!startTotalLoss || item.totalLoss >= startTotalLoss) &&
                   (!endTotalLoss || item.totalLoss <= endTotalLoss) &&
                   (!startTotalOrderQuantity || item.totalOrderQuantity >= startTotalOrderQuantity) &&
                   (!endTotalOrderQuantity || item.totalOrderQuantity <= endTotalOrderQuantity) &&
                   (!startTotalReturnQuantity || item.totalReturnQuantity >= startTotalReturnQuantity) &&
                   (!endTotalReturnQuantity || item.totalReturnQuantity <= endTotalReturnQuantity);
        });

    // 필터링된 데이터를 다시 설정
    salesAmountGrid.resetData(filteredData);
}

	// 검색 엔터 이벤트 추가
	document.querySelectorAll(".card-body input").forEach((ele) => {
	    ele.addEventListener('keydown', (event) => {				
	        if (event.keyCode === 13) {
	        	searchSalesLossAmount();
	        }
	    });
	});

	// 검색 조건 초기화 함수
	function resetCondition() {
	    document.querySelectorAll('.card-body input').forEach((e) => {
	        e.value = null;
	    });
	    searchSalesLossAmount();
	}
	
	</script>
</body>
<style>
</style>
</html>