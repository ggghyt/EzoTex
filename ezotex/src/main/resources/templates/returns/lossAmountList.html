<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layouts/layout}" layout:fragment="content">
<head>
<meta charset="UTF-8">
<title>이조텍스SCM</title>
<link rel="stylesheet"
	href="https://uicdn.toast.com/grid/latest/tui-grid.css" />
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://uicdn.toast.com/grid/latest/tui-grid.js"></script>
<script src="https://uicdn.toast.com/chart/latest/toastui-chart.min.js"></script>
</head>
<body>
	<h3 class="fs-3 fw-bold">| 손실액 조회</h3>
	<div class="card card-body mt-3 bg-secondary">
		<h3>검색</h3>
		<table class="table mt-3">
			<tbody>
				<!-- 첫 번째 줄 -->
				<tr>
					<td class="col-auto"><label class="col-form-label">제품명</label></td>
					<td class="col-auto"><input type="text" id="productName"
						class="form-control"></td>
					<td class="col-auto"><label class="col-form-label">주문일</label></td>
					<td class="col-auto"><input type="date" id="startOrderDate"
						class="form-control"></td>
					<td>~</td>
					<td class="col-auto"><input type="date" id="endOrderDate"
						class="form-control"></td>
				</tr>
				<!-- 두 번째 줄 -->
				<tr>
					<td class="col-auto"><label class="col-form-label">매출액</label></td>
					<td class="col-auto"><input type="text" id="startTotalSales"
						class="form-control"></td>
					<td>~</td>
					<td class="col-auto"><input type="date" id="endTotalSales"
						class="form-control"></td>
					<td class="col-auto"><label class="col-form-label">손실액</label></td>
					<td class="col-auto"><input type="text" id="startTotalLoss"
						class="form-control"></td>
					<td>~</td>
					<td class="col-auto"><input type="text" id="endTotalLoss"
						class="form-control"></td>

				</tr>
				<!-- 세번째 줄 -->
				<tr>
					<td class="col-auto"><label class="col-form-label">주문수량</label></td>
					<td class="col-auto"><input type="text"
						id="startTotalOrderQuantity" class="form-control"></td>
					<td>~</td>
					<td class="col-auto"><input type="text"
						id="endTotalOrderQuantity" class="form-control"></td>
					<td class="col-auto"><label class="col-form-label">반품수량</label></td>
					<td class="col-auto"><input type="text"
						id="startTotalReturnQuantity" class="form-control"></td>
					<td>~</td>
					<td class="col-auto"><input type="text"
						id="endTotalReturnQuantity" class="form-control"></td>
				</tr>
			</tbody>
		</table>
		<div class="text-center mt-3">
			<button class="btn btn-warning mag-glass-btn"
				onclick="searchSalesLossAmount()">
				<i class="fa-solid fa-magnifying-glass icon-left"
					style="color: #ffffff;"></i>
			</button>
			<button class="btn btn-secondary mag-glass-btn"
				onclick="resetCondition()">
				<i class="fa-solid fa-repeat icon-left" style="color: #ffffff;"></i>
			</button>
		</div>

	</div>

	<!-- 제품 손실액 조회할 그리드 -->
	<div class="card card-body mt-3">
		<h3>제품별 일일 손실액</h3>
		<div id="salesAmountGrid"></div>
		<h3>제품별 일일 손실액 차트</h3>
		<div id="lossChart" style="height: 400px;"></div>
	</div>


	<script th:inline="javascript">
	<!-- 그리드에 넣어줄 데이터 -->
	const salesAmountList = /*[[${getSalesAmount}]]*/[];
	
	// 매출액 + 손실액
	const salesAmountGrid = new tui.Grid({
		el : document.getElementById('salesAmountGrid'),
		scrollX : false, // 가로 스크롤바 비활성화
		scrollY : false, // 세로 스크롤바 비활성화
		data : salesAmountList,
		bodyHeight : 200,
		rowHeaders : [{
			type : 'rowNum',
			header : 'NO'
		}],
		columns : [{
			header : '주문일',
			name : 'orderDate',
			align : 'center',
		},{
			header : '제품명',
			name : 'productName',
			align : 'center',
		},{
			header : '매출액',
			name : 'totalSales',
			align : 'right',
	        formatter: function({ value }) {
	            return value ? value.toLocaleString() : '0';
	        },
		},{
			header : '손실액',
			name : 'totalLoss',
			align : 'right',
	        formatter: function({ value }) {
	            return value ? value.toLocaleString() : '0';
	        },
		},{
			header : '주문량',
			name : 'totalOrderQuantity',
			align : 'right',
	        formatter: function({ value }) {
	            return value ? value.toLocaleString() : '0';
	        },
		},{
			header : '반품량',
			name : 'totalReturnQuantity',
			align : 'right',
	        formatter: function({ value }) {
	            return value ? value.toLocaleString() : '0';
	        },
		}],
	    pageOptions: {
	        useClient: true, // 페이징을 위해 필요
	        perPage: 5
      	},
	})
	
	let lossChart = null; // 차트 객체 저장

	let lastClicked = null; // 페이지 이동 시에도 이전 선택 기억하기 위함.
	// 행 클릭 이벤트 추가
	salesAmountGrid.on('click', (ev) => {
		
		salesAmountGrid.removeRowClassName(lastClicked, 'bg-blue'); // 이전 선택 행 배경색 삭제
		salesAmountGrid.addRowClassName(ev.rowKey, 'bg-blue'); // 선택된 행 배경색 추가
	    lastClicked = ev.rowKey; // 선택된 행 기억
	    
	    const rowData = salesAmountGrid.getRow(ev.rowKey);
	    if (rowData) {
	        updateChart(rowData);
	    }
	});
	

	// 차트 업데이트 함수
	function updateChart(data) {
	    const chartData = {
	        categories: ['매출액', '손실액', '주문량', '반품량'],
	        series: [
	            {
	                name: `${data.productName} (${data.orderDate})`, // 제품명 + 날짜 포함
	                data: [
	                    data.totalSales || 0,
	                    data.totalLoss || 0,
	                    data.totalOrderQuantity || 0,
	                    data.totalReturnQuantity || 0
	                ]
	            }
	        ]
	    };

	    const options = {
	        chart: { width: 700, height: 400, title: `손실액 차트 - ${data.productName} (${data.orderDate})` },
	        xAxis: { categories: chartData.categories },
	        series: { showLabel: false },
	        tooltip: {
	        	enabled : false
	        }
	    };

	    if (lossChart) {
	        lossChart.setOptions(options);
	        lossChart.setData(chartData);
	    } else {
	        lossChart = toastui.Chart.columnChart({ el: document.getElementById('lossChart'), data: chartData, options });
	    }
	}
	
	// 손실액 검색 함수
	function searchSalesLossAmount() {
        const productName = document.querySelector('#productName').value;
        const startOrderDate = document.querySelector('#startOrderDate').value;
        const endOrderDate = document.querySelector('#endOrderDate').value;
        const startTotalSales = document.querySelector('#startTotalSales').value;
        const endTotalSales = document.querySelector('#endTotalSales').value;
        const startTotalLoss = document.querySelector('#startTotalLoss').value;
        const endTotalLoss = document.querySelector('#endTotalLoss').value;
        const startTotalOrderQuantity = document.querySelector('#startTotalOrderQuantity').value;
        const endTotalOrderQuantity = document.querySelector('#endTotalOrderQuantity').value;
        const startTotalReturnQuantity = document.querySelector('#startTotalReturnQuantity').value;
        const endTotalReturnQuantity = document.querySelector('#endTotalReturnQuantity').value;
        
        const filteredData = salesAmountList.filter(item => {
            return (!productName || item.productName.includes(productName)) &&
                   (!startOrderDate || item.orderDate >= startOrderDate) &&
                   (!endOrderDate || item.orderDate <= endOrderDate) &&
                   (!startTotalSales || item.totalSales >= startTotalSales) &&
                   (!endTotalSales || item.totalSales <= endTotalSales) &&
                   (!startTotalLoss || item.totalLoss >= startTotalLoss) &&
                   (!endTotalLoss || item.totalLoss <= endTotalLoss) &&
                   (!startTotalOrderQuantity || item.totalOrderQuantity >= startTotalOrderQuantity) &&
                   (!endTotalOrderQuantity || item.totalOrderQuantity <= endTotalOrderQuantity) &&
                   (!startTotalReturnQuantity || item.totalReturnQuantity >= startTotalReturnQuantity) &&
                   (!endTotalReturnQuantity || item.totalReturnQuantity <= endTotalReturnQuantity);
        });

    // 필터링된 데이터를 다시 설정
    salesAmountGrid.resetData(filteredData);
}

	// 검색 엔터 이벤트 추가
	document.querySelectorAll(".card-body input").forEach((ele) => {
	    ele.addEventListener('keydown', (event) => {				
	        if (event.keyCode === 13) {
	        	searchSalesLossAmount();
	        }
	    });
	});

	// 검색 조건 초기화 함수
	function resetCondition() {
	    document.querySelectorAll('.card-body input').forEach((e) => {
	        e.value = null;
	    });
	    searchSalesLossAmount();
	}
	
	</script>
</body>
<style>
</style>
</html>