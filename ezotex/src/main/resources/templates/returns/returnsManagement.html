<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layouts/layout}" layout:fragment="content">
<head>
<meta charset="UTF-8">
<title>이조텍스SCM</title>
<link rel="stylesheet"
	href="https://uicdn.toast.com/grid/latest/tui-grid.css" />
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://uicdn.toast.com/grid/latest/tui-grid.js"></script>
</head>
<body>
	<h3 class="fs-3 fw-bold">|반품</h3>
	<button type="button" class="btn btn-info" data-bs-toggle="modal"
		data-bs-target="#deliveryViewModal">납품 내역 조회</button>
	<p>
	<div class="card card-body w-100" style="background-color: #d3d3d3;">
		<table class="table mt-3">
			<tbody>
				<!-- 첫 번째 줄 -->
				<tr>
					<td class="col-auto">
						<div class="d-flex align-items-center">
							<label class="col-form-label me-2" style="width: 80px;">납품코드
							</label> <input type="text" id="deliveryCode" class="form-control w-50">
						</div>
					</td>
					<td class="col-auto">
						<div class="d-flex align-items-center">
							<label class="col-form-label me-2" style="width: 80px;">업체코드</label>
							<input type="text" id="companyCode" class="form-control w-50">
						</div>
					</td>
					<td class="col-auto">
						<div class="d-flex align-items-center">
							<label class="col-form-label me-2" style="width: 80px;">업체명</label>
							<input type="text" id="companyName" class="form-control w-50">
						</div>
					</td>
				</tr>
				<!-- 두 번째 줄 -->
				<tr>
					<td class="col-auto">
						<div class="d-flex align-items-center">
							<label class="col-form-label me-2" style="width: 80px;">담당자</label>
							<input type="text" id="requestor" class="form-control w-50">
						</div>
					</td>
					<td class="col-auto">
						<div class="d-flex align-items-center">
							<label class="col-form-label me-2" style="width: 80px;">처리상태</label>
							<select id="status" class="form-select w-50">
								<option value="return">반품</option>
								<option value="exchange">교환</option>
								<option value="dispose">폐기</option>
							</select>
						</div>
					</td>
				</tr>
			</tbody>
		</table>
	</div>
	<div class="card card-body mt-3">
		<h3>|제품목록</h3>
		<div id="deliProductGrid" style="width: 100%;"></div>
		<script th:inline="javascript">
			// 사이즈 정해주기
			const sizeMap = {
				    SI01: 'FREE', SI02: 'XS', SI03: 'S', SI04: 'M', SI05: 'L',
				    SI06: 'XL', SI07: 'XXL', SI25: '25', SI26: '26', SI27: '27',
				    SI28: '28', SI29: '29', SI30: '30', SI31: '31', SI32: '32',
				    SI33: '33', SI34: '34', SI35: '35', SI36: '36', SI37: '37',
				    SI38: '38', SI44: '44', SI55: '55', SI66: '66', SI77: '77',
				    SI88: '88', SI90: '90'
			};
			// Thymeleaf에서 데이터를 JSON으로 변환해서 JavaScript로 전달
			const deliProduct = /*[[${getDeliProduct}]]*/[];
			// 전달된 데이터 확인 (콘솔에 출력)
			console.log(deliProduct);
			// Toast Grid 설정
			// --- 제품 추가 그리드 ---
			const deliProductGrid = new tui.Grid({
				el : document.getElementById('deliProductGrid'), // 그리드를 표시할 div
				scrollX : false, // 가로 스크롤바 비활성화
				scrollY : false, // 세로 스크롤바 비활성화
				bodyHeight : 200,
				data : deliProduct, // 서버에서 전달된 데이터
				columnOptions : {
					resizable : false
				// 컬럼 크기 조절 가능
				},
				rowHeaders : [ 'rowNum' ],
				columns : [
				{
					header : '납품코드',
					name : 'deliveryCode',
					align : 'center',
				},
				{
					header : '제품명',
					name : 'productName',
					align : 'center',
				},
				{
					header : '색상',
					name : 'productColor',
					align : 'center',
				},
				{
					header : '사이즈',
					name : 'productSize',
					align : 'center',
		            formatter: ({ value }) => sizeMap[value] || 'Unknown'
				},
				{
					header : '수량',
					name : 'requestQy',
					align : 'center',
				},
				{
					header : '단가',
					name : 'unitPrice',
					align : 'center',
				},
			    {
				      header: '처리상태',
				      name: 'status',
				      align: 'center',

			    },
				],
				pageOptions : {
					useClient : true, // 페이징을 위해 필요
					perPage : 5
				},
			});
		</script>
	</div>
	<div class="card card-body mt-3">
		<h4>|처리할 제품</h4>
		<div id="selectProductGrid" style="width: 100%;"></div>
		<script th:inline="javascript">
			const selectProductGrid = new tui.Grid({
				el : document.getElementById('selectProductGrid'), // 그리드를 표시할 div
				scrollX : false, // 가로 스크롤바 비활성화
				scrollY : false, // 세로 스크롤바 비활성화
				data : deliProduct, // 서버에서 전달된 데이터
				columnOptions : {
					resizable : false
				// 컬럼 크기 조절 가능
				},
				columns : [
				{
					header : '제품코드',
					name : 'productCode',
					align : 'center',
				},
				{
					header : '제품명',
					name : 'productName',
					align : 'center',
				},
				{
					header : '색상',
					name : 'productColor',
					align : 'center',
				},
				{
					header : '사이즈',
					name : 'productSize',
					align : 'center',
				},
				{
					header : '단가',
					name : 'unitPrice',
					align : 'center',
				},
				{
					header : '수량',
					name : 'requestQy',
					align : 'center',
				},
				{
					header : '총금액',
					name : 'amount',
					align : 'center',
				},
				],
				pageOptions : {
					useClient : true, // 페이징을 위해 필요
					perPage : 1
				},
			});
			</script>
	</div>
</body>
<!-- 납품 내역 조회 모달 -->
<div class="modal fade" id="deliveryViewModal" tabindex="-1"
	aria-labelledby="deliveryViewModalLabel" aria-hidden="true">
	<div class="modal-dialog" style="width: 50%; max-width: 1200px;">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="deliveryViewModalLabel">반품할 납품건 선택</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal"
					aria-label="Close"></button>
			</div>
			<div class="modal-body">
				<div class="card card-body mt-3">
					<div class="row">
						<!-- Toast Grid를 표시할 div 추가 -->
						<div class="col-12 card card-body m-2">
							<p class="fs-5 fw-bolder">납품내역 선택 모달</p>
							<!-- 그리드를 표시할 div -->
							<div id="deliveryGrid" style="width: 100%;"></div>
						</div>
					</div>
				</div>
				<script th:inline="javascript">
					// Thymeleaf에서 getProductList 데이터를 JSON으로 변환해서 JavaScript로 전달
					const deliveryList = /*[[${getDeliveryList}]]*/[];
					// 전달된 데이터 확인 (콘솔에 출력)
					console.log(deliveryList);
					// Toast Grid 설정
					// --- 제품 추가 그리드 ---
					const deliveryGrid = new tui.Grid({
						el : document.getElementById('deliveryGrid'), // 그리드를 표시할 div
						scrollX : false, // 가로 스크롤바 비활성화
						scrollY : false, // 세로 스크롤바 비활성화
						bodyHeight : 200,
						data : deliveryList, // 서버에서 전달된 데이터
						columnOptions : {
							resizable : false
						// 컬럼 크기 조절 가능
						},
						rowHeaders : [ 'rowNum' ],
						columns : [ {
							header : '납품코드',
							name : 'deliveryCode',
							align : 'center',
						}, {
							header : '주문코드',
							name : 'productOrderCode',
							align : 'center',
						}, {
							header : '업체명',
							name : 'companyName',
							align : 'center',
						}, {
							header : '납품 상태',
							name : 'deliveryStatus',
							align : 'center',
							formatter : function(value) {
								const status = value.value;
								if (typeof status === 'string') {
									switch (status) {
									case 'DS01':
										return '납품등록';
									case 'DS02':
										return '포장완료';
									case 'DS03':
										return '기사배정';
									case 'DS04':
										return '배송출발';
									case 'DS05':
										return '납품완료';
									case 'DS06':
										return '반품';
									case 'RS01':
										return '대기';
									case 'RS02':
										return '부분출고';
									case 'RS03':
										return '출고완료';
									case 'RS04':
										return '취소';
									default:
										return status;
									}
								}
								return status;
							}
						}, {
							header : '납기일',
							name : 'dedt',
							align : 'center',
						}

						],
						pageOptions : {
							useClient : true, // 페이징을 위해 필요
							perPage : 5
						},
					});
					const modalElement = document
							.getElementById('deliveryViewModal');
					modalElement.addEventListener('show.bs.modal', function() {
						deliveryGrid.refreshLayout(); // 모달이 열리기 전에 그리드 레이아웃 재조정
					});
				</script>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary"
					data-bs-dismiss="modal">닫기</button>
			</div>
		</div>
	</div>
</div>
<script>
	// 납품 내역 선택 모달 행 클릭 이벤트
	deliveryGrid.on('click',function(ev) {
						const clickedRow = ev.rowKey; // 클릭된 행
						const clickedData = deliveryGrid.getData()[clickedRow]; //클릭된 행의 데이터

						console.log("클릭 이벤트 확인", clickedData);

						// 클릭된 행의 데이터 입력
						document.getElementById('deliveryCode').value = clickedData.deliveryCode;
						document.getElementById('companyCode').value = clickedData.companyCode;
						document.getElementById('companyName').value = clickedData.companyName;

						$('#deliveryViewModal').modal('hide');
						
						fetch(`http://localhost:80/returns/returnsProduct?deliveryCode=${clickedData.deliveryCode}`)
							.then(response => response.json())
							.then(data => {
								console.log("코드 데이터 확인",data);
								deliProductGrid.resetData(data);
							});
					});
	// 페이지 시작 할때 작업
	window.onload = function() {
		// 현재 로그인된 사용자 입력
		document.getElementById('requestor').value = '[[${name}]]';
	};
</script>

<style>
.modal {
	display: block !important; /* Bootstrap 기본 동작 우회 */
	visibility: hidden;
}

.modal.show {
	visibility: visible;
}

#status {
	-webkit-appearance: none !important;
	-moz-appearance: none !important;
	appearance: none !important;
}
</style>
</html>