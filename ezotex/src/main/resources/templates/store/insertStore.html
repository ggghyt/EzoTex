<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layouts/layout}" layout:fragment="content">
<head>
<meta charset="UTF-8">
<title>이조텍스SCM</title>
<!-- timePicker -->
<link rel="stylesheet"
	href="https://uicdn.toast.com/tui.time-picker/latest/tui-time-picker.css" />
<script
	src="https://uicdn.toast.com/tui.time-picker/latest/tui-time-picker.js"></script>

<!-- datePicker -->
<link rel="stylesheet"
	href="https://uicdn.toast.com/tui.date-picker/latest/tui-date-picker.css" />
<script
	src="https://uicdn.toast.com/tui.date-picker/latest/tui-date-picker.js"></script>

<!-- paging -->
<link rel="stylesheet"
	href="https://uicdn.toast.com/tui.pagination/latest/tui-pagination.css" />
<script
	src="https://uicdn.toast.com/tui.pagination/latest/tui-pagination.js"></script>

<!-- toast grid -->
<link rel="stylesheet"
	href="https://uicdn.toast.com/grid/latest/tui-grid.css" />
<script src="https://uicdn.toast.com/grid/latest/tui-grid.js"></script>
<style type="text/css">
#modalGrid {
	width: 100%;
	height: 400px; /* 또는 원하는 높이 설정 */
	overflow-y: scroll;
}
</style>
</head>
<body>

	<!-- 창고모달 -->
	<div class="modal fade" id="exampleModal" tabindex="-1"
		aria-labelledby="exampleModalLabel" aria-hidden="true">
		<div class="modal-dialog modal-xl">
			<div class="modal-content">
				<div class="modal-header"></div>
				<div class="card">
					<div class="card-body">
						<div class="mb-3 row">
							<label for="inputPassword" class="col-sm-2 col-form-label">검색조건1</label>
							<div class="col-sm-10">
								<input type="text" class="form-control" id="inputPassword"
									style="width: 200px;">
							</div>
						</div>
						<div class="mb-3 row">
							<label for="inputPassword" class="col-sm-2 col-form-label">검색조건2</label>
							<div class="col-sm-10">
								<input type="text" class="form-control" id="inputPassword"
									style="width: 200px;">
							</div>
						</div>

						<div id="modalGrid"></div>
					</div>
				</div>
				<div style="text-align: center; margin: 20px;">
					<button type="button" class="btn btn-outline-primary btn-fw">수정</button>
					<button type="button" class="btn btn-inverse-dark btn-fw"
						data-bs-dismiss="modal">취소</button>
				</div>
			</div>
		</div>
	</div>



	<div class="d-flex align-items-center">
		<h3 class="fs-3 fw-bold">| 제품 입고 등록</h3>
		<!-- <button class="btn btn-secondary" style="margin: 10px;">자재 입고</button>
		<button class="btn btn-secondary" style="margin: 10px;">제품 입고</button> -->
	</div>
	<div class="row">
			<div class="col-5 card card-body m-2"
				style="background-color: #d3d3d3;">
				<p class="fs-5 fw-bolder">주문 정보</p>
				<table class="table mt-3">
					<tbody>
						<!-- 첫 번째 줄 -->
						<tr>
							<!-- 							<td class="col-auto"><label class="col-form-label">주문코드</label>
								<input type="text" id="productOrderCode" class="form-control"
								readonly></td> -->
							<td class="col-auto"><label class="col-form-label">제품코드</label>
							 <input type="text" id="charger" class="form-control"></td>
							<td class="col-auto"><label class="col-form-label">제품명</label>
								<input type="text" id="empCode" class="form-control" readonly></td>
							<td class="col-4"><label class="col-form-label">제품이미지</label></td>
						</tr>
						<!-- 두 번째 줄 -->
						<tr>
							<td class="col-auto"><label class="col-form-label">대분류</label>
							<select class="form-control">
								<option value="null">전체</option>
							</select></td>
							<td class="col-auto"><label class="col-form-label">소분류</label>
							<select class="form-control">
								<option value="null">전체</option>
							</select></td>
							<td class="col-4">
								<img alt="" src=""></td>
						</tr>
					</tbody>
				</table>
				<div class="d-flex justify-content-center gap-2">
					<button class="btn btn-secondary mag-glass-btn btn-sm"><i class="fa-solid fa-magnifying-glass icon-left-sm" style="color: #646464;"></i></button>
					<button class="btn btn-warning mag-glass-btn btn-sm"><i class="fa-solid fa-repeat icon-left-sm" style="color: #ffffff;"></i></button>
				</div>
			</div>
		</div>
		
		
		
		
		
		
		<div class="row">
			<div class="col-5 card card-body m-2">
				<p class="fs-5 fw-bolder mt-2">제품 목록</p>
				<div id="grid">
					<div id="pagination" class="tui-pagination"></div>
				</div>
			</div>

			<div class="col-5 card card-body m-2">
				<p class="fs-5 fw-bolder mt-2">입고 등록</p>
				<div id="grid2"></div>

				<div class="d-flex justify-content-end mt-2">
					<div class="col">
				<div class="card card-body mt-3">
					
					<!-- 제품 상세 정보 및 BOM 정보 -->
					<div class="d-flex align-items-top">
							<p class="fs-5 fw-bolder mb-3 me-3">선택한 제품</p>
							<label style="font-size: 10pt" for="remember">입력항목 유지</label><input type="checkbox" id="remember" class="ms-1 mb-4">
					</div>
					<div class="row">
						<label class="col-4 col-lg-2 d-flex mb-2 align-items-center justify-content-center wbreak">제품코드</label>
						<div class="col-8 col-lg-4 d-flex mb-2">
							<input type="search" class="form-control" id="productCode" readonly>
						</div>
						<label class="col-4 col-lg-2 d-flex mb-2 align-items-center justify-content-center wbreak">제품명</label>
						<div class="col-8 col-lg-4 d-flex mb-2">
							<input type="search" class="form-control" id="productName" readonly>
						</div>
						
						<label for="color" class="col-4 col-lg-2 d-flex mb-2 align-items-center justify-content-center wbreak">색상</label>
						<div class="col-8 col-lg-4 d-flex mb-2">
							<select class="form-control" id="color" name="color">
								<option value="null">전체</option>
							</select>
						</div>
						<label for="size" class="col-4 col-lg-2 d-flex mb-2 align-items-center justify-content-center wbreak">사이즈</label>
						<div class="col-8 col-lg-4 d-flex mb-2">
							<select class="form-control" id="size" name="size">
								<option value="null">전체</option>
							</select>
						</div>
						<div class="d-flex justify-content-end mt-2">
							<button type="button" id="addProduct" class="btn btn-primary registBtn" style="width:150px">제품추가</button>
						</div>
					</div>
					<hr style="height: 0.1px">
						<div id="storeProduct"></div>
						<div class="d-flex justify-content-end mt-2">
							<button id="productInsert" type="button" class="btn btn-primary"
								style="height: 45px; margin-top: 10px;">등록</button>
							<button class="btn btn-secondary" style="margin: 10px;">초기화</button>
						</div>
				</div>

			</div>
		</div>

	</div>
	
	</div>


	<!-- 등록 버튼 클릭 -->

	<!-- 등록 모달 -->
	<div class="modal fade" id="registModal" tabindex="-1"
		aria-labelledby="exampleModalLabel" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header" style="height: 20px;">
					<h5 class="modal-title" id="exampleModalLabel"
						style="font-size: 15px;">등록 확인</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal"
						aria-label="Close"></button>
				</div>
				<div class="modal-body"
					style="text-align: center; padding: 44px; padding-bottom: 10px;">
					<div>
						<img src="/images/modal/regist.png" alt="등록확인이미지"
							style="width: 84px; height: 84px;">
					</div>
					<div>
						<p style="margin-top: 12px; font-size: 21px; font-weight: bold;">알림</p>
						<p>내용을 등록하시겠습니까?</p>
					</div>
				</div>
				<div class="modal-footer regist"
					style="display: flex; justify-content: center; border-top: none; padding-bottom: 45px;">
					<!---->
					<button type="button" id="InsertTest"
						class="btn btn-outline-primary checkBtn" data-bs-dismiss="modal">등록</button>
					<button type="button" class="btn btn-secondary denyBtn"
						data-bs-dismiss="modal">취소</button>
				</div>
			</div>
		</div>
	</div>



	<!-- Toast UI Grid 스크립트 -->
	<script>
		let productCode = "";
		let productColor = "";
		let productName = "";
	   	
		let obj = []
		
		/*
	   	*========================================================================
	   	* 제품 목록 그리드 
	   	*========================================================================
	   	*/
		
	    const dataSource = {
	      api: {
	          readData: { url: 'http://localhost:80/store/productInfoList', method: 'GET' },
	        },
	      contentType: 'application/json',
	    };  
	    
	    const storeGrid = new Grid({
	      el: document.getElementById('grid'), // 컨테이너 엘리먼트
	      rowHeaders: ['rowNum'],
	      columnOptions: {
	          resizable: true
	      },
	      pageOptions:{
	          useClient: false,
	          perPage: 10
	        },
	      columns: [ 
	        { header: "제품코드", name: "productCode", align: "center"},
	        { header: "제품명", name: "productName", align: "center"},
	        { header: "단가", name: "unitPrice", align: "center"},
	      ],
	      data: dataSource,
	    });
	    
	    /*
	   	*========================================================================
	   	* 제품 목록 그리드 END
	   	*========================================================================
	   	*/
	    
	   	
	   	/*
	   	*========================================================================
	   	* 제품 입고 그리드 
	   	*========================================================================
	   	*/
	   	const storeProduct = new Grid({
	   		el: document.getElementById('storeProduct'),
	   		rowHeaders: ['rowNum'],
	   		columns: [
	   			{ header: "제품코드", name: "productCode", align: "center" },
	   			{ header: "제품명", name: "productName", align: "center" },
	   			{ header: "색상", name: "color", align: "center" },
	   			{ header: "사이즈", name: "sizeCode", align: "center" },
	   			{ header: "수량", name: "productQy", editor: "text" },
	   			{ header: "창고위치", name: "location" },
	   		],
	   		data: [],
	   	})
	   	
	   	
	    const modalGrid = new Grid({
	    	el: document.getElementById('modalGrid'),
	    	rowHeaders: ['rowNum'],
	    	columns: [
	    		{ header: "창고코드", name: "storageCode" },
	    		{ header: "창고상세코드", name: "storageInfoCode" },
	    		{ header: "창고이름", name: "storageInfoName" },
	    	],
	    	data: [],
	    })
	    
	   	/*
	   	*========================================================================
	   	* 제품 입고 그리드 END
	   	*========================================================================
	   	*/
	   	
	   	
	   	
	   	
	    
	    
	    /*
	   	*========================================================================
	   	* 1번 그리드 클릭시 해당 제품 색상 데이터 가져오기
	   	*========================================================================
	   	*/
	    
	    storeGrid.on('click', ev => {

	    	let data = storeGrid.getRow(ev.rowKey);
	    	document.querySelector('#productCode').value = data.productCode;
	    	document.querySelector('#productName').value = data.productName;
	    	
	    	productCode = data.productCode;
	    	productName = data.productName;
	    	
	    	 // 색상 옵션 가져오기
	        fetch(`http://localhost:80/store/productColor?productCode=${data.productCode}`)
	            .then(response => response.json())
	            .then(colors => {
					
	            	productColor = colors.productColor
	            	
	                let colorSelect = document.querySelector('#color');
	                colorSelect.innerHTML = '<option value="null">전체</option>'; // 기존 옵션 초기화
	                
	                let sizeSelect = document.querySelector('#size');
			    	sizeSelect.innerHTML = '<option value="null">전체</option>';

	                colors.forEach(color => {
	                    colorSelect.insertAdjacentHTML(
	                        'beforeend',
	                        `<option value="${color.productColor}">${color.productColor}</option>`
	                    );
	                });
	            })
	    	
	    })
	    
	    
	    /*
	   	*========================================================================
	   	* 1번 그리드 클릭시 해당 제품 색상 데이터 가져오기 END
	   	*========================================================================
	   	*/
	    
	   
	   	
	   	
	   	
	   	
	   	/*
	   	*========================================================================
	   	* 색상선택시 색상 사이즈 데이터 가져오기 
	   	*========================================================================
	   	*/
	   	
	    color.addEventListener('change', function () {
	    	productColor = this.value;
	    	productCode = document.querySelector('#productCode').value;
	    	
			fetch(`http://localhost:80/store/productSize?productCode=${productCode}&productColor=${productColor}`)
			     .then(req => req.json())
			     .then(data => {
			    	let sizeSelect = document.querySelector('#size');
			    	sizeSelect.innerHTML = '<option value="null">전체</option>';
			    	
			    	data.forEach(sizeItem => {
			    		let sizeInfo = getSizeCommonCode(sizeItem.productSize)
			    		productSize = sizeItem.productSize;
			    		sizeSelect.insertAdjacentHTML(
			    			'beforeend',
			    			`<option value="${sizeInfo}">${sizeItem.productSize}</option>`
			    		)
			    	})
			    	
			    	
			     })
	   	});

	    
	    
	    /*
	   	*========================================================================
	   	* 색상선택시 색상 사이즈 데이터 가져오기 END!! 
	   	*========================================================================
	   	*/
	    
	   	
	   	size.addEventListener('click', function(){
	   		productSize = this.options[this.selectedIndex].text;
	   	})
	   	
	   	
	   	
	    
	   	/*
	   	*========================================================================
	   	* 제품추가 버튼 클릭 이벤트 
	   	*========================================================================
	   	*/

		// 제품 추가 버튼 클릭 시
		addProduct.addEventListener('click', function () {
		    console.log('클릭');
		    productCode = document.querySelector('#productCode').value;
		    if (productCode == null || productCode == "") {
		        console.log('제품을 선택하세요');
		    } else {
		        // 이미 3번 그리드에 있는지 확인
		        let isProductExist = false;
		
		        // storeProduct의 데이터를 순회하여 이미 추가된 제품이 있는지 확인
		        storeProduct.getData().forEach(item => {
		            if (item.productCode === productCode && item.color === productColor && item.sizeCode === productSize) {
		                isProductExist = true; // 이미 있는 제품
		            }
		        });
		
		        if (isProductExist) {
		            alert('이미 등록된 제품입니다.');
		        } else {
		            // 새로운 제품 추가
		            let objInfo = {
		                productCode: productCode,
		                productName: productName,
		                color: productColor,
		                sizeCode: productSize,
		                productQy: "" ,// 초기 수량은 빈 문자열로 설정
		                //storageLocation : location
		            };
		
		            // 기존 데이터에 추가
		            let currentData = storeProduct.getData();  // 현재 데이터 가져오기
		            currentData.push(objInfo);  // 새로운 제품을 추가
		
		            // storeProduct의 데이터를 갱신 (기존 데이터 + 새 데이터)
		            storeProduct.resetData(currentData);
		
		            console.log('제품이 추가되었습니다.');
		        }
		    }
		});






	   	
	   	/*
	   	*========================================================================
	   	* 제품추가 버튼 클릭 이벤트 END!!
	   	*========================================================================
	   	*/
	   	
	   	
	   	
	   	
	   	
	   	/*
	   	*========================================================================
	   	* 제품등록 처리
	   	*========================================================================
	   	*/
	   	
	   	productInsert.addEventListener('click', function(){
	   		
	   		let check = storeProduct.getData();
	   		
	   		if(check.length == 0){
	   			alert('선택된 제품이 없습니다. 제품을 추가해주세요.');
	   			return ;
	   		}
	   		
	   		for (let i = 0; i < check.length; i++) {
	   	        if (!check[i].productQy || check[i].productQy.trim() === "") {
	   	            alert(`제품 ${check[i].productName} 의 수량을 입력해주세요.`);
	   	            return; 
	   	        }
	   	     	if(!check[i].location || check[i].location.trim() === "") {
	   	            alert(`창고위치를 선택하세요 .`);
	   	            return; 
	   	        }
	   	    }
	   		
	   		// 데이터에서 사이즈 값 변환
	   	   let transformedData = check.map(item => {
	   	        // 사이즈 값 변환
	   	        item.sizeCode = getSizeCommonCode(item.sizeCode);
	   	        
	   	     console.log(item.sizeCode);
	   	        
	   	        return item;
	   	    });
	   		
	   		console.log("서버 통신 데이터 : ", transformedData);
	   		fetch(`http://localhost:80/store/InsertProduct`,{
	   			method: 'POST',
	   			headers: {...headers, 'Content-Type': 'application/json'},
	    		body: JSON.stringify(transformedData)
	   		}).then(rep => rep.json())
	   		  .then(result => {
	   			  location.reload();
	   			  console.log(result);
	   		  })
	   		
	   	})
	   	
	   	
	    
	   	
	   	/*
	   	*========================================================================
	   	* 제품등록 처리 END!!
	   	*========================================================================
	   	*/
	   	
	   	
	   	
	   	
	   	
	   	
	   	/*
	   	*========================================================================
	   	* 창고위치 모달 그리드 데이터
	   	*========================================================================
	   	*/
	   	
	   	storeProduct.on('click', ev => {
	   		
	   		if(ev.columnName == "location"){
	   			console.log("창고위치 클릭시 발동")
	   			let modal = new bootstrap.Modal(document.getElementById('exampleModal'));
		        modal.show();
		        
	   			fetch(`http://localhost:80/store/storageInfoList`)
	   			    .then(rep => rep.json())
	   			    .then(data => {
	   			    	modalGrid.resetData(data);
	   			    })
	   		}
	   	})
	   	
	    /*
	   	*========================================================================
	   	* 창고위치 모달 그리드 데이터 END!!
	   	*========================================================================
	   	*/
	   	
	   	
	   	modalGrid.on('click', ev => {
	   	    let data = modalGrid.getRow(ev.rowKey);
	   	    console.log("선택한 창고 데이터:", data);
	   	    
	   	    let selectedRowKey = storeProduct.getFocusedCell()?.rowKey; // 현재 선택된 storeProduct 행 가져오기
	   	    
	   	    if (selectedRowKey !== null && selectedRowKey !== undefined) {
	   	        storeProduct.setValue(selectedRowKey, 'location', data.storageInfoCode); // location 값 업데이트
	   	    }

	   	    // 기존 모달 인스턴스 가져와서 닫기
	   	    let modalElement = document.getElementById('exampleModal');
	   	    let modalInstance = bootstrap.Modal.getInstance(modalElement); // 기존 모달 가져오기

	   	    if (modalInstance) {
	   	        modalInstance.hide(); // 모달 닫기
	   	    }
	   	});

	   	
	   	
	   	
	   	
	   	
	   	
	   	
	    
	    // Bootstrap 모달 이벤트 리스너 추가
		const modalElement = document.getElementById('exampleModal');

		modalElement.addEventListener('show.bs.modal', function () {
		    modalElement.style.display = 'block'; // 모달을 블록으로 변경
		    modalElement.style.opacity = '0'; // 투명하게 숨김
		});
		
		modalElement.addEventListener('shown.bs.modal', function () {
			modalGrid.refreshLayout();  // 모달이 완전히 뜬 후 크기 조정
		    modalElement.style.opacity = '1'; // 투명도 복원
		}); 


	    
	    </script>

</body>
</html>