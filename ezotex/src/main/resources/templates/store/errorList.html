<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout}"
      layout:fragment="content">
	<head>
		<meta charset="UTF-8">
		<title>이조텍스SCM</title>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
	</head>
	<body>
		<div class="d-flex align-items-center">
		<h3 class="fs-3 fw-bold">| 불량 제품 조회</h3>
		<!-- <button class="btn btn-secondary" style="margin: 10px;">자재 입고</button>
		<button class="btn btn-secondary" style="margin: 10px;">제품 입고</button> -->
	</div>
	
	
	<div class="modal fade" id="modifyMOdal" tabindex="-1"
		aria-labelledby="exampleModalLabel" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header" style="height: 20px;">
					<h5 class="modal-title" id="exampleModalLabel"
						style="font-size: 15px;">수정 확인</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal"
						aria-label="Close"></button>
				</div>
				<div class="modal-body"
					style="text-align: center; padding: 44px; padding-bottom: 10px;">
					<div>
						<img src="/images/modal/modify.png" alt="등록확인이미지"
							style="width: 84px; height: 84px;">
					</div>
					<div>
						<p style="margin-top: 12px; font-size: 21px; font-weight: bold;">경고</p>
						<p id="warning"></p>
					</div>
				</div>
				<div class="modal-footer modify"
					style="display: flex; justify-content: center; border-top: none; padding-bottom: 45px;">
					<!---->
					<button type="button" class="btn btn-outline-warning checkBtn"
						data-bs-dismiss="modal">확인</button>
				</div>
			</div>
		</div>
	</div>
	
	<div class="row ps-2">
	  <div class="col-12 card card-body m-2  bg-secondary">
	    <p class="fs-5 fw-bolder">제품 정보</p>
	
	    <div class="row ps-2">
					
				<label class="col-4 col-sm-2 col-lg-1 d-flex mb-2 align-items-center justify-content-center wbreak">제품코드</label>
				<div class="col-8 col-sm-4 col-lg-2 d-flex mb-2">
					<input type="text" class="form-control pointer bg-white storeSearch" id="searchProductCode" placeholder="찾기" >
				</div>
				<label class="col-4 col-sm-2 col-lg-1 d-flex mb-2 align-items-center justify-content-center wbreak">제품명</label>
				<div class="col-8 col-sm-4 col-lg-2 d-flex mb-2">
					<input type="text" class="form-control storeSearch" id="searchProductName">
				</div>
				<label class="col-4 col-sm-2 col-lg-1 d-flex mb-2 align-items-center justify-content-center wbreak">색상</label>
				<div class="col-8 col-sm-4 col-lg-2 d-flex mb-2">
					<input type="text" class="form-control storeSearch" id="searchColor">
				</div>
				<label class="col-4 col-sm-2 col-lg-1 d-flex mb-2 align-items-center justify-content-center wbreak">사이즈</label>
				<div class="col-8 col-sm-4 col-lg-2 d-flex mb-2">
					<input type="text" class="form-control storeSearch" id="searchSize">
				</div>
				<label class="col-4 col-sm-2 col-lg-1 d-flex mb-2 align-items-center justify-content-center wbreak">LOT</label>
				<div class="col-8 col-sm-4 col-lg-2 d-flex mb-2">
					<input type="text" class="form-control storeSearch" id="searchLot">
				</div>
				<label class="col-4 col-sm-2 col-lg-1 d-flex mb-2 align-items-center justify-content-center wbreak">처리담당자</label>
				<div class="col-8 col-sm-4 col-lg-2 d-flex mb-2">
					<input type="text" class="form-control storeSearch" id="requestor">
				</div>
				
				<label class="col-3 col-sm-2 col-lg-1 d-flex mb-2 align-items-center justify-content-center wbreak">불량 처리일</label>
				<div class="col-8 col-sm-3 col-lg-2 d-flex mb-2" style="margin-right: 50px;">
					<input type="date" class="form-control text-end storeSearch" id="startErrorDate" style="margin-right: 10px;"> ~ 
					<input type="date" class="form-control text-end storeSearch" id="endErrorDate" style="margin-left: 10px;">
				</div>
			</div>
		
	    <!-- 버튼 -->
	    <div class="d-flex justify-content-center mt-2">
           <button type="button" id="planSearchBtn" class="btn btn-warning mag-glass-btn me-2" onclick="searchErrorProductList()"><i class="fa-solid fa-magnifying-glass icon-left" style="color: #ffffff;"></i></button>
           <button id="inputReset" type="reset" class="btn btn-secondary mag-glass-btn"><i class="fa-solid fa-repeat icon-left" style="color: #ffffff;"></i></button>
         </div>
	  </div>
	</div>
	
	
	<div class="row">
		<div class="col-5 card card-body m-2">
			<div class="d-flex justify-content-between align-items-center mt-2 mb-2">
				<p class="fs-5 fw-bolder m-0">불량 제품 목록</p>
				<button id="xlsx" class="btn btn-dark btn-sm" style="width: 200px;">EXCEL 내보내기</button>
			</div>
			<div id="grid"></div>
		</div>
	</div>
	
	<div class="card-body">
          <div class="d-sm-flex justify-content-between align-items-start">
            <div>
             <h4 class="card-title card-title-dash">불량률</h4>
            </div>
            <div id="performance-line-legend"><div class="chartjs-legend"><ul><li><span style="background-color:#1F3BB3"></span>This week</li><li><span style="background-color:#52CDFF"></span>Last week</li></ul></div></div>
          </div>
          <div class="chartjs-wrapper mt-5"><div class="chartjs-size-monitor"><div class="chartjs-size-monitor-expand"><div class=""></div></div><div class="chartjs-size-monitor-shrink"><div class=""></div></div></div>
            <canvas id="performaneLine" width="511" height="150" style="display: block; width: 511px; height: 150px;" class="chartjs-render-monitor"></canvas>
          </div>
        </div>
	
	
	
	
	<div class="card-body">
       <div class="d-sm-flex justify-content-between align-items-start">
         <div>
           <h4 class="card-title card-title-dash">불량률</h4>
         </div>
       </div>
       <div class="d-sm-flex align-items-center mt-1 justify-content-between">
         <div class="me-3"><div id="marketing-overview-legend"><div class="chartjs-legend"><ul><li class="text-muted text-small"><span style="background-color:#52CDFF"></span>Last week</li><li class="text-muted text-small"><span style="background-color:#1F3BB3"></span>This week</li></ul></div></div></div>
       </div>
       <div class="chartjs-bar-wrapper mt-3"><div class="chartjs-size-monitor"><div class="chartjs-size-monitor-expand"><div class=""></div></div><div class="chartjs-size-monitor-shrink"><div class=""></div></div></div>
         <canvas id="marketingOverview" width="511" height="150" style="display: block; width: 511px; height: 150px;" class="chartjs-render-monitor"></canvas>
       </div>
     </div>
	 
	
	<script>
	
	
		
	
		var today = new Date();
	
		var year = today.getFullYear();
		var month = ('0' + (today.getMonth() + 1)).slice(-2);
		var day = ('0' + today.getDate()).slice(-2);
	
		var dateString = year +  month  + day;
	
		console.log(dateString);
		
		
		var today = new Date();   

		var hours = ('0' + today.getHours()).slice(-2); 
		var minutes = ('0' + today.getMinutes()).slice(-2);
		var seconds = ('0' + today.getSeconds()).slice(-2); 

		var timeString = hours +  '00';

		console.log(timeString);
	
	
		var xhr = new XMLHttpRequest();
		var url = 'http://apis.data.go.kr/1360000/VilageFcstInfoService_2.0/getUltraSrtFcst'; /*URL*/
		var queryParams = '?' + encodeURIComponent('serviceKey') + '='+'PKUNSIsmZZpZ0P658K43O39GNlqv26nAx4GaY0lOgv%2FEvupoDxYM1zxIypb%2BS2uz6ZbrA%2BmnFTXlO4j0awAF7w%3D%3D'; /*Service Key*/
		queryParams += '&' + encodeURIComponent('pageNo') + '=' + encodeURIComponent('1'); /**/
		queryParams += '&' + encodeURIComponent('numOfRows') + '=' + encodeURIComponent('1000'); /**/
		queryParams += '&' + encodeURIComponent('dataType') + '=' + encodeURIComponent('JSON'); /**/
		queryParams += '&' + encodeURIComponent('base_date') + '=' + encodeURIComponent(dateString); /**/
		queryParams += '&' + encodeURIComponent('base_time') + '=' + encodeURIComponent(timeString); /**/
		queryParams += '&' + encodeURIComponent('nx') + '=' + encodeURIComponent('35'); /**/
		queryParams += '&' + encodeURIComponent('ny') + '=' + encodeURIComponent('128'); /**/
		xhr.open('GET', url + queryParams);
		xhr.onreadystatechange = function () {
		    if (this.readyState == 4) {
		        console.log('Status: '+this.status+'nHeaders: '+JSON.stringify(this.getAllResponseHeaders())+'nBody: '+this.responseText);
		        
		        if (this.readyState == 4 && this.status == 200) {
		            var result = JSON.parse(this.responseText);
		            var items = result.response.body.items.item;
		            
		            var filteredData = items.filter(function(item) {
		                return item.category === 'T1H'; // T1H: 기온
		            });

		            console.log('기온 데이터:', filteredData);
		            
		            var sky = items.filter(function(item){
		            	return item.category === 'SKY';
		            })
		            
		            if (sky.length > 0) {
		            	if(sky[0].fcstValue == 1){
		            		console.log('맑음');
		            	}
		                console.log('첫 번째 기온:', sky[0].fcstValue + '하늘, 시간: ' + sky[0].fcstTime);
		            }
		            
		            
		            if (filteredData.length > 0) {
		                console.log('첫 번째 기온:', filteredData[0].fcstValue + '°C, 시간: ' + filteredData[0].fcstTime);
		            }
		        }
		    }
		};
		
		xhr.send('');
		
	
	
		document.querySelectorAll('.storeSearch').forEach((ev) => {
			ev.addEventListener('keydown', (ev) => {
				if(window.event.keyCode == 13){
					searchErrorProductList();
				}
			})
		})
	
	
		document.getElementById('xlsx').addEventListener('click', () => {
			  const checkedRows = errorGrid.getCheckedRows(); // 체크된 데이터 가져오기
			  if (checkedRows.length === 0){
				  let modifyMOdal = new bootstrap.Modal(document.getElementById('modifyMOdal'));
				  document.querySelector("#warning").innerText = "선택된 제품이 없습니다.";
					modifyMOdal.show();
				  return; // 체크된 데이터가 없으면 미동작
			  }
	
			  // 체크된 데이터만 내보내기
			  errorGrid.export('xlsx', {
			    useFormattedValue: true,
			    fileName: '불량재고' + '_' + dateFormatter().replaceAll('-', ''),
			    rows: checkedRows // 체크된 행만 내보내기
			  });
			});
		
		inputReset.addEventListener('click', function(){
			document.querySelector("#searchProductCode").value = '';
			document.querySelector("#searchProductName").value = '';
			document.querySelector("#searchColor").value = '';
			document.querySelector("#searchSize").value = '';
			document.querySelector("#searchLot").value = '';
			document.querySelector("#requestor").value = '';
			document.querySelector("#startErrorDate").value = '';
			document.querySelector("#endErrorDate").value = '';
			searchErrorProductList();
		})
	
			function searchErrorProductList(){
				errorGrid.readData(1,{
					productCode: document.querySelector("#searchProductCode").value,
					productName: document.querySelector("#searchProductName").value,
					color: document.querySelector("#searchColor").value,
					sizeCode: getSizeCommonCode(document.querySelector("#searchSize").value.toUpperCase()),
					searchLot: document.querySelector("#searchLot").value,
					requestor: document.querySelector("#requestor").value,
					startErrorDate: document.querySelector("#startErrorDate").value,
					endErrorDate: document.querySelector("#endErrorDate").value,
				}, false)
			}
	
			const dataSource = {
		      api: {
		          readData: { url: '/store/errorProductList', method: 'GET' },
		        },
		      contentType: 'application/json',
		    };  
		    
		    const errorGrid = new Grid({
		      el: document.getElementById('grid'), // 컨테이너 엘리먼트
		      rowHeaders: ['rowNum','checkbox'],
		      columnOptions: {
		          resizable: true
		      },
		      pageOptions:{
		          useClient: false,
		          perPage: 10
		        },
		      bodyHeight: 417,
		      columns: [ 
		        { header: "제품코드", name: "productCode", align: "center", sortable: true},
		        { header: "제품명", name: "productName", sortable: true, width: 200},
		        { header: "색상", name: "productColor", sortable: true},
		        { header: "사이즈", name: "productSize", sortable: true},
		        { header: "LOT번호", name: "lot", align: "center", sortable: true},
		        { header: "처리일", name: "processDate", sortable: true, formatter: (row) => dateFormatterNull(row.value)},
		        { header: "처리담당자", name: "errorCharger", align: "center", sortable: true},
		        
		      ],
		      data: dataSource,
		      showDummyRows: true
		    });
		    
		    
		    
		    
		    function getSelectedRows() {
		        const checkedRows = errorGrid.getCheckedRows();
		        return checkedRows.map(row => row.productCode);
		    }

		    
		    function exportSelectedToPDF(){
		    	let data = getSelectedRows();
		    	window.open(`/store/ErrorPdfview`, '_blank', 'width=1000', 'scrollbars=yes');
		    }
		    
		    
	</script>
	
	</body>
</html>