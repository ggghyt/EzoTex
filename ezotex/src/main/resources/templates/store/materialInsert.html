<html xmlns:th="http://www.thymeleaf.org"
     xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
     layout:decorate="~{layouts/layout}"
     layout:fragment="content">
<head>
	<meta charset="UTF-8">
	<title>이조텍스SCM</title>
<style type="text/css">
#modalGrid {
	width: 100%;
	height: 400px; /* 또는 원하는 높이 설정 */
	overflow-y: scroll;
}
</style>
</head>
	<body>
		<div class="d-flex align-items-center">
			<h3 class="fs-3 fw-bold">| 자재 입고 등록</h3>
			<!-- <button class="btn btn-secondary" style="margin: 10px;">자재 입고</button>
			<button class="btn btn-secondary" style="margin: 10px;">제품 입고</button> -->
		</div>
	<div class="row ps-2">
	  <div class="col-12 card card-body m-2" style="background-color: #d3d3d3;">
	    <p class="fs-5 fw-bolder">제품 정보</p>
	
	    <div class="row ps-2">
				<label class="col-4 col-sm-2 col-lg-1 d-flex mb-2 align-items-center justify-content-center wbreak">납품코드</label>
				<div class="col-8 col-sm-4 col-lg-2 d-flex mb-2">
					<input type="text" class="form-control pointer bg-white" id="searchDeliveryCode" placeholder="찾기" >
				</div>
				
				
				<label class="col-3 col-sm-2 col-lg-1 d-flex mb-2 align-items-center justify-content-center wbreak">납품 요청일</label>
				<div class="col-8 col-sm-3 col-lg-2 d-flex mb-2" style="margin-right: 50px;">
					<input type="date" class="form-control text-end" id="startOrderDate" style="margin-right: 10px;"> ~ 
					<input type="date" class="form-control text-end" id="endOrderDate" style="margin-left: 10px;">
				</div>
				
				<label class="col-3 col-sm-2 col-lg-1 d-flex mb-2 align-items-center justify-content-center wbreak">입고 예정일</label>
				<div class="col-8 col-sm-3 col-lg-2 d-flex mb-2">
					<input type="date" class="form-control text-end" id="startDedt" style="margin-right: 10px;"> ~ 
					<input type="date" class="form-control text-end" id="endDedt" style="margin-left: 10px;">
				</div>
				
				<!-- <label  class="col-4 col-sm-2 col-lg-1 d-flex mb-2 align-items-center justify-content-center wbreak">구분</label>
				<div class="col-8 col-sm-4 col-lg-2 d-flex mb-2">
					<select class="form-control" id="se">
						<option value="null">제품/자재</option>
						<option value="PT02">제품</option>
						<option value="PT01">자재</option>
					</select>
				</div> -->
			</div>
	
	    <!-- 버튼 -->
	    <div class="d-flex justify-content-center mt-2">
           <button type="button" id="planSearchBtn" class="btn btn-secondary mag-glass-btn me-2" onclick="searchDeliveryList()"><i class="fa-solid fa-magnifying-glass icon-left" style="color: #646464;"></i></button>
           <button id="inputReset" type="reset" class="btn btn-warning mag-glass-btn"><i class="fa-solid fa-repeat icon-left" style="color: #ffffff;"></i></button>
         </div>
	  </div>
	</div>

		
		<div class="row">
			<div class="col-5 card card-body m-2">
				<p class="fs-5 fw-bolder mt-2">납품 목록</p>
				<div id="grid">
					<div id="pagination" class="tui-pagination"></div>
				</div>
			</div>
			
			
			<div class="col-5 card card-body m-2">
				<p class="fs-5 fw-bolder mt-2">납품 목록상세</p>
				<div id="mtGrid2"></div>
				
				<div class="d-flex justify-content-end mt-2">
					<button id="InsertTest" type="button" class="btn btn-primary registBtn"
						style="height: 45px; margin-top: 10px;">등록</button>
					<button class="btn btn-secondary" style="margin: 10px;" id="resetBtn">초기화</button>
				</div>
				
			</div>
			
		</div>
		
		
		
	<!-- 창고모달 -->
	<div class="modal fade" id="exampleModal" tabindex="-1"
		aria-labelledby="exampleModalLabel" aria-hidden="true">
		<div class="modal-dialog modal-xl">
			<div class="modal-content">
				<div class="modal-header"></div>
				<div class="card">
					<div class="card-body">
						<div class="mb-3 row">
							<label for="inputPassword" class="col-sm-2 col-form-label">검색조건1</label>
							<div class="col-sm-10">
								<input type="text" class="form-control" id="inputPassword"
									style="width: 200px;">
							</div>
						</div>
						<div class="mb-3 row">
							<label for="inputPassword" class="col-sm-2 col-form-label">검색조건2</label>
							<div class="col-sm-10">
								<input type="text" class="form-control" id="inputPassword"
									style="width: 200px;">
							</div>
						</div>

						<div id="modalGrid"></div>
					</div>
				</div>
				<div style="text-align: center; margin: 20px;">
					<button type="button" class="btn btn-outline-primary btn-fw">수정</button>
					<button type="button" class="btn btn-inverse-dark btn-fw"
						data-bs-dismiss="modal">취소</button>
				</div>
			</div>
		</div>
	</div>	
		
		
	<!-- 등록 모달 -->
	<div class="modal fade" id="registModal" tabindex="-1"
		aria-labelledby="exampleModalLabel" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header" style="height: 20px;">
					<h5 class="modal-title" id="exampleModalLabel"
						style="font-size: 15px;">등록 확인</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal"
						aria-label="Close"></button>
				</div>
				<div class="modal-body"
					style="text-align: center; padding: 44px; padding-bottom: 10px;">
					<div>
						<img src="/images/modal/regist.png" alt="등록확인이미지"
							style="width: 84px; height: 84px;">
					</div>
					<div>
						<p style="margin-top: 12px; font-size: 21px; font-weight: bold;">알림</p>
						<p>내용을 등록하시겠습니까?</p>
					</div>
				</div>
				<div class="modal-footer regist"
					style="display: flex; justify-content: center; border-top: none; padding-bottom: 45px;">
					<!---->
					<button type="button" id="productMtInsert"
						class="btn btn-outline-primary checkBtn" data-bs-dismiss="modal">등록</button>
					<button type="button" class="btn btn-secondary denyBtn"
						data-bs-dismiss="modal">취소</button>
				</div>
			</div>
		</div>
	</div>
	
	
	<!-- 경고 모달 -->
      <div class="modal fade" id="modifyMOdal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header" style="height: 20px;">
              <h5 class="modal-title" id="exampleModalLabel" style="font-size: 15px;">수정 확인</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="text-align: center; padding: 44px; padding-bottom:10px;">
              <div>
                <img src="/images/modal/modify.png" alt="등록확인이미지" style="width: 84px; height:84px; ">
              </div>
              <div>
                <p style="margin-top: 12px;
                font-size: 21px;
                font-weight: bold;">알림</p>
                <p id="warning">내용을 수정하시겠습니까?</p>
              </div>
            </div>
            <div class="modal-footer modify" style="display: flex; justify-content: center; border-top: none; padding-bottom:45px;">
              <!---->
              <button type="button" class="btn btn-outline-warning checkBtn" data-bs-dismiss="modal">확인</button>
              <button type="button" class="btn btn-secondary denyBtn" data-bs-dismiss="modal">취소</button>
            </div>
          </div>
        </div>
      </div>
		
		
		
		<script>
		
		inputReset.addEventListener('click', function(){
			document.getElementById('searchDeliveryCode').value = '';  // 납품코드 초기화
		    document.getElementById('startOrderDate').value = '';  // 납품 요청일 시작일 초기화
		    document.getElementById('endOrderDate').value = '';  // 납품 요청일 종료일 초기화
		    document.getElementById('startDedt').value = '';  // 입고 예정일 시작일 초기화
		    document.getElementById('endDedt').value = '';  // 입고 예정일 종료일 초기화
		    searchDeliveryList();
		})
		
		
		 //초기화 화면 새로고침
		document.getElementById('resetBtn').addEventListener('click', function() {
		    window.location.reload();  // 페이지 새로 고침
		 });
		
			function searchDeliveryList() {
				mtGrid.readData(1, {
	        		deliveryCode: document.querySelector('#searchDeliveryCode').value,
	        		startOrderDate: document.querySelector('#startOrderDate').value,
	        		endOrderDate: document.querySelector('#endOrderDate').value,
	        		startDedt: document.querySelector('#startDedt').value,
	        		endDedt: document.querySelector('#endDedt').value,
	        	}, false);	//안에 값 넣으면 됨 파라미터 세개 (1:몊번째 페이지 불러올 것인가, 2:검색조건, 3:true=기존데이터 초기화)
	        }
		
		//납품코드
		let deliveryCode = '';
	
	
	
		const mtDataSource = {
				api: {
					readData: { url: '/store/mtDeliveryList', method: 'GET' }
				},
				contentType: 'application/json',
		};
		
		const mtGrid = new Grid({
			el: document.getElementById('grid'),
			rowHeaders: ['rowNum'],
			pageOptions:{
				useClient: false,
				perPage: 10
			},
			columns: [
				{ header: "납품코드", name: "deliveryCode", align: "center" },
				{ header: "제품 종류 수", name: "deliveryQy", align: "center" },
				{ header: "납품 요청일", name: "orderDate", align: "center" },
				{ header: "입고 예정일", name: "dedt", align: "center" },
			],
			data: mtDataSource,
		})
		
		
		let lastClicked = null;
		
		mtGrid.on('click', ev => {
			
			let data = mtGrid.getRow(ev.rowKey);
			deliveryCode = data.deliveryCode;
			console.log(deliveryCode);
			mtGrid.removeRowClassName(lastClicked, 'bg-blue');
			mtGrid.addRowClassName(ev.rowKey, 'bg-blue');
			lastClicked = ev.rowKey;
			fetch(`/store/mtDeliveryDetailsList?deliveryCode=${deliveryCode}`)
			     .then(rep => rep.json())
			     .then(data => {
			    	 data.forEach(item => item.deliveryCode = deliveryCode); 
			    	 mtGrid2.resetData(data);
			     })
		})
		
		/* 
		mtGrid.on('focusChange', ev => {
			// 배경색 클래스 적용
			prdGrid.removeRowClassName(lastClicked, 'bg-blue'); // 이전 선택 행 배경색 삭제
			prdGrid.addRowClassName(ev.rowKey, 'bg-blue'); // 선택된 행 배경색 추가
		}); */
		
		
		const mtGrid2 = new Grid({
			el: document.getElementById('mtGrid2'),
			rowHeaders: ['rowNum'],
			scrollY: true,
			height: 500,
			columns: [
				{ header: "제품코드", name: "productCode", align: "center" },
				{ header: "제품명", name: "productName", align: "center" },
				{ header: "색상", name: "productColor", align: "center" },
				{ header: "납품수량", name: "productQy", align: "center" },
				{ header: "미처리수량", name: "qy", align: "center" },
				{ header: "입고수량", name: "productInsertQy", editor: "text" },
				{ header: "창고위치", name: "location"  },
				{ header: "납품코드", name: "deliveryCode", hidden: true },
			],
			data: []
		})
		
			
		const modalGrid = new Grid({
	    	el: document.getElementById('modalGrid'),
	    	rowHeaders: ['rowNum'],
	    	columns: [
	    		{ header: "창고코드", name: "storageCode" },
	    		{ header: "창고상세코드", name: "storageInfoCode" },
	    		{ header: "창고이름", name: "storageInfoName" },
	    	],
	    	data: [],
	    })
			
			
		let insertData = []
		
		mtGrid2.on('afterChange', ev => {
		    if (!ev || !ev.changes) return;
		    
		    ev.changes.forEach(change => {
		        let data = mtGrid2.getRow(change.rowKey);
		        if (change.columnName === 'productInsertQy' || change.columnName === 'location') {
		        	
		            insertData = insertData.filter(item => {
		                return !(item.productCode === data.productCode &&
		                         item.productColor === data.productColor &&
		                         item.productName === data.productName);
		            });
		            
		            insertData.push(data);
		        }

		        if (data.qy < data.productInsertQy) {
		            mtGrid2.setValue(change.rowKey, 'productInsertQy', data.qy);
		        }
		    });
		});

			
		mtGrid2.on('click', ev => {
			if(ev.columnName == "location"){
				let modal = new bootstrap.Modal(document.getElementById('exampleModal'));
		        modal.show();
		        
		        fetch(`/store/storageInfoList`)
   			    .then(rep => rep.json())
   			    .then(data => {
   			    	modalGrid.resetData(data);
   			    })
			}
		})
		
		
		
		InsertTest.addEventListener('click', function(){
			let modal = new bootstrap.Modal(document.getElementById('registModal'));
			let modifyMOdal = new bootstrap.Modal(document.getElementById('modifyMOdal'));
			let check = mtGrid2.getData();
			
			if(check.length == 0){
				document.querySelector("#warning").innerText = "선택된 제품이 없습니다.";
				modifyMOdal.show();
				return ;
			}
			
		     let Insertcheck = insertData.find(item => {
					return !item.productInsertQy || !item.location;
				})
				
				if(Insertcheck){
					document.querySelector("#warning").innerText = "값을 모두 입력하세요.";
					modifyMOdal.show();
					return
				}
			
			
			
		        modal.show();
		})
		
		
		productMtInsert.addEventListener('click', function(){
			
			fetch(`/store/productMtInsert`, {
				method: 'POST',
				headers: {...headers, 'Content-Type': 'application/json'},
				body: JSON.stringify(insertData)
			}).then(rep => rep.json())
			  .then(result => {
				  console.log(result);
				  fetch(`/store/mtDeliveryDetailsList?deliveryCode=${deliveryCode}`)
				     .then(rep => rep.json())
				     .then(data => {
				    	 data.forEach(item => item.deliveryCode = deliveryCode); 
				    	 mtGrid2.resetData(data);
				     })
				  
			  })
		})
			
		modalGrid.on('click', ev => {
		    let data = modalGrid.getRow(ev.rowKey);
		    console.log("선택한 창고 데이터:", data);
			
		    let selectedRowKey = mtGrid2.getFocusedCell()?.rowKey; // 현재 선택된 mtGrid2 행 가져오기
		
		    if (selectedRowKey !== null && selectedRowKey !== undefined) {
		        // 창고 정보로 location 값 업데이트
		        mtGrid2.setValue(selectedRowKey, 'location', data.storageInfoCode);
		    }
		
		    // 모달 인스턴스 가져오기
		    let modalElement = document.getElementById('exampleModal');
		    let modalInstance = bootstrap.Modal.getInstance(modalElement); // 기존 모달 인스턴스 가져오기
		
		    if (modalInstance) {
		        modalInstance.hide(); // 모달 닫기
		    }
		});

		// 모달 열기와 닫기 처리 시 스타일 및 레이아웃 조정
		const modalElement = document.getElementById('exampleModal');
		
		// 모달이 열리기 전에 실행
		modalElement.addEventListener('show.bs.modal', function () {
		    modalElement.style.display = 'block'; // 모달을 블록으로 변경
		    modalElement.style.opacity = '0'; // 투명하게 숨김
		});
		
		// 모달이 완전히 열린 후 실행
		modalElement.addEventListener('shown.bs.modal', function () {
		    modalGrid.refreshLayout();  // 모달이 완전히 뜬 후 그리드 레이아웃 새로고침
		    modalElement.style.opacity = '1'; // 투명도 복원
		});
			
		</script>
		
		
		
	</body>
</html>