<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layouts/layout}" layout:fragment="content">
<head>
<meta charset="UTF-8">
<title>이조텍스SCM</title>
<link rel="stylesheet"
	href="https://uicdn.toast.com/grid/latest/tui-grid.css" />
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://uicdn.toast.com/grid/latest/tui-grid.js"></script>
<script>
// 인풋 초기화 함수
function resetForm() {
    // 모든 input 필드를 비운다
    const inputs = document.querySelectorAll('input');
    inputs.forEach(input => {
        input.value = '';  // 값 초기화
    });
}
// 모든 제품의 총 수량 계산
let totalOrderQuantity = 0;
let productCode = "";
</script>
</head>
<body>
	<h3 class="fs-3 fw-bold">| 주문 관리</h3>
	<div class="card card-body mt-3">
		<div class="row">
			<div class="col-5 card card-body m-2"
				style="background-color: #d3d3d3;">
				<p class="fs-5 fw-bolder">주문 등록</p>
				<table class="table mt-3">
					<tbody>
						<!-- 첫 번째 줄 -->
						<tr>
							<td class="col-auto"><label class="col-form-label">주문코드</label>
								<input type="text" id="productOrderCode" class="form-control"
								readonly></td>
							<td class="col-auto"><label class="col-form-label">주문
									담당자</label> <input type="text" id="charger" class="form-control"
								readonly></td>
							<td class="col-auto"><label class="col-form-label">사원코드</label>
								<input type="text" id="empCode" class="form-control" readonly></td>
							<td class="col-auto"><label class="col-form-label">업체코드</label>
								<input type="text" id="companyCode" class="form-control"
								onclick="showCompanyCodeModal()"></td>
							<td class="col-auto"><label class="col-form-label">업체명</label>
								<input type="text" id="company" class="form-control" readonly></td>
						</tr>
						<!-- 두 번째 줄 -->
						<tr>
							<td class="col-auto"><label class="col-form-label">업체
									담당자</label> <input type="text" id="companyCharger" class="form-control"
								readonly></td>
							<td class="col-auto"><label class="col-form-label">전화번호</label>
								<input type="text" id="companyTel" class="form-control">
							</td>
							<td class="col-auto"><label class="col-form-label">주문일</label>
								<input type="date" id="orderDate" class="form-control" readonly>
							</td>
							<td class="col-auto"><label class="col-form-label">납기일</label>
								<input type="date" id="deliveryRequestDeadline"
								class="form-control"></td>
							<td class="col-auto"><label class="col-form-label">주문상태</label>
								<input type="text" id="orderStatus" class="form-control"
								readonly></td>
						</tr>
					</tbody>
				</table>
				<label class="col-form-label">비고</label> <input type="text"
					id="remarks" class="form-control" placeholder="특이사항을 입력해주세요.">
				<button type="button" onclick="resetForm()">초기화</button>
			</div>
		</div>
		<div class="row align-items-center">
			<div class="fs-5 fw-bolder">제품 목록</div>
			<div class="d-flex justify-content-end gap-2">
				<button type="button" class="btn btn-info btn-sm"
					data-bs-toggle="modal" data-bs-target="#productCodeModal">제품
					추가</button>
				<button id="btnDelete" class="btn btn-danger btn-sm">삭제</button>
			</div>
		</div>
		<!-- //제품목록 그리드 -->
		<div id="grid" style="width: 100%;"></div>
		<script>
    // 기본 옵션 설정
    const grid = new tui.Grid({
      el: document.getElementById('grid'), // 그리드를 표시할 엘리먼트
      scrollX: false, // 가로 스크롤바 비활성화
      scrollY: false, // 세로 스크롤바 비활성화
      rowHeight: 'auto',  // 행 높이를 자동으로 조정
      rowHeaders: ['checkbox'],
      columns: [  // 컬럼 설정 (빈 컬럼으로 초기화)
        {
          header: 'NO',
          name: 'no',	
          align: 'center',
        },
        {
          header: '제품 코드',
          name: 'productCode',
          align: 'center',
        },
        {
          header: '제품명',
          name: 'productName',
          align: 'center',
        },
        {
          header: '단가',
          name: 'unitPrice',
          align: 'right',
        },
        {
          header: '주문 수량',
          name: 'orderQuantity',
          align: 'right',
        },
        {
          header: '주문 금액',
          name: 'orderAmount',
          align: 'right',
        }
      ],
      data: [], // 빈 데이터로 초기화
    });
    grid.on('click', function(ev) {
        const clickedRowKey = ev.rowKey; // 클릭한 행의 키
        const clickedData = grid.getRow(clickedRowKey); // 클릭한 행의 데이터
        
        // "선택한 제품" 입력 필드에 값 설정
        document.getElementById('selectProductCode').value = clickedData.productCode;
        document.getElementById('selectProductName').value = clickedData.productName;
        
        productCode = clickedData.productCode;
        console.log("ㅍㄹㄷㅌ",productCode);
        
        // 이미 저장된 수량 데이터가 있는지 확인
        const savedData = savedProductData.find(data => data.productCode === productCode);

        if (savedData) {
            // 저장된 데이터가 있으면 옵션 그리드에 데이터 다시 설정
            optionGrid.resetData(savedData.quantities);
        } else {
            // 저장된 데이터가 없으면 빈 데이터로 초기화
            optionGrid.resetData([]);
	        fetch(`http://localhost:80/order/ProductOption?productCode=${productCode}`)  // 서버에서 색상, 사이즈 데이터를 가져옴
	            .then(response => response.json())
	            .then(data => {
	        console.log(productCode , "서버연결되는지" , data);
	        optionGrid.resetData(data);
	        });
        }

    });
    
    document.getElementById("btnDelete").addEventListener("click", function () {
    	  const checkedRows = grid.getCheckedRows(); // 선택된 행 가져오기
    	  const rowKeys = checkedRows.map(row => row.rowKey); // 행 키 배열 만들기
    	  console.log("삭제할 행 키:", rowKeys); // 삭제할 행 확인용 로그
    	  rowKeys.forEach(rowKey => grid.removeRow(rowKey)); // 선택된 행 삭제
    	});
  </script>
	</div>
	<div class="row">
		<div class="col-5 card card-body m-2">
			<p class="fs-5 fw-bolder">선택한 제품</p>
			<table class="table mt-3">
				<tr class="d-flex">
					<td class="d-flex align-items-center mr-3"><label
						class="col-form-label mr-3">제품코드</label> <input type="text"
						id="selectProductCode" class="form-control" style="width: 200px;"
						placeholder="제품코드" readonly></td>
					<td class="d-flex align-items-center"><label
						class="col-form-label mr-3">제품명</label> <input type="text"
						id="selectProductName" class="form-control" style="width: 200px;"
						placeholder="제품명" readonly></td>
				</tr>
			</table>
			<div id="productOption" style="width: 100%;">
				<button type="button" onclick="saveProductData()">저장</button>
			</div>
			<div id="register-button-container">
				<button type="button" onclick="insertOrder()">등록</button>
				<!-- modifyData 연결 -->
			</div>

		</div>
		<script th:inline="javascript">
		// Thymeleaf에서 productOption 데이터를 JSON으로 변환해서 JavaScript로 전달
		const productOption = /*[[${getProductOption}]]*/[];
		// 전달된 데이터 확인 (콘솔에 출력)
		// Toast Grid 설정
		// --- 제품 옵션 그리드 ---
		const optionGrid = new tui.Grid(
				{
					el : document.getElementById('productOption'), // 그리드를 표시할 div
					  scrollX: false, // 가로 스크롤바 비활성화
					  scrollY: false, // 세로 스크롤바 비활성화
					data : 
						productOption,// 서버에서 전달된 데이터
						api:{
							modifyData : { url: '/order/insertOrder' , method: 'POST' , headers} ,
						}
					,
					columnOptions : {
						resizable : true
						
					// 컬럼 크기 조절 가능
					},
					columns : [
					{
						header : '제품코드',
						name : productCode,
						hidden:true
					}
						,
					{ 
						header : '색상/사이즈',
						name : 'productColor',
						align : 'center',	
			            width: 150 // 고정 크기 설정

					},
					{ 
						header : 'XS',
						name : 'size_XS',
						align : 'center',	
						editor: 'text',
			            width: 150

					},
					{ 
						header : 'S',
						name : 'size_S',
						align : 'center',	
						editor: 'text',
			            width: 150

					},
					{ 
						header : 'M',
						name : 'size_M',
						align : 'center',	
						editor: 'text',
			            width: 150

					},
					{ 
						header : 'L',
						name : 'size_L',
						align : 'center',	
						editor: 'text',
			            width: 150

					},
					{ 
						header : 'XL',
						name : 'size_XL',
						align : 'center',	
						editor: 'text',
			            width: 150

					},
					{ 
						header : 'FREE SIZE',
						name : 'size_FREE',
						align : 'center',	
						editor: 'text',
			            width: 150
					},
					],
					width: 1050,
				    bodyHeight: 100, 
				    autoWidth: true  // 자동 너비 조절
				});
		// 제품별로 입력된 수량을 저장할 배열
		let savedProductData = [];

		// 수량을 저장하는 함수
		function saveProductData() {
		    const selectedProductCode = document.getElementById('selectProductCode').value;  // 선택된 제품 코드
		    const rows = optionGrid.getData();  // 제품 옵션 그리드 데이터
	
		    // 수량 데이터를 배열에 저장
		    const productData = {
		        productCode: selectedProductCode,
		        quantities: rows.map(row => ({
		        	productCode: selectedProductCode,
		        	productColor: row.productColor,  // 색상
		            size_XS: row.size_XS,  // XS 사이즈 수량
		            size_S: row.size_S,  // S 사이즈 수량
		            size_M: row.size_M,  // M 사이즈 수량
		            size_L: row.size_L,  // L 사이즈 수량
		            size_XL: row.size_XL,  // XL 사이즈 수량
		            size_FREE: row.size_FREE  // FREE 사이즈 수량
		        }))
		    };

		    // 배열에 해당 제품 데이터 추가 (기존에 있으면 업데이트)
		    const index = savedProductData.findIndex(data => data.productCode === selectedProductCode);
		    console.log(index,"ttttt");
		    if (index > -1) {
		        savedProductData[index] = productData;  // 기존 데이터 업데이트
		    } else {
		        savedProductData.push(productData);  // 새로 추가
		    }

		    console.log('저장된 제품 데이터:', savedProductData);
		}
		  // 등록이벤트함수
		  let newData = [];		
		  let newData2 = [];

		  function insertOrder(productCode) {
			    const orderData = {
			        charger: document.getElementById("charger").value, // 담당자
			        empCode: document.getElementById("empCode").value, // 담당자 사원코드
			        companyCode: document.getElementById("companyCode").value, // 업체코드
			        company: document.getElementById("company").value, // 업체
			        companyCharger: document.getElementById("companyCharger").value, // 업체담당자
			        companyTel: document.getElementById("companyTel").value, // 업체담당자 전화번호
			        deliveryRequestDeadline: document.getElementById("deliveryRequestDeadline").value, // 납기일
			        orderStatus: document.getElementById("orderStatus").value, // 주문 상태 - 기본값 : 대기
			        remarks: document.getElementById("remarks").value, // 비고 
			    };
			    const orderProductData = {
			        productList: grid.getData(),  // 제품 정보 : 제품코드 , 제품명 단가 등등
			        option : newData2 // 제품 색상,사이즈,수량			    		
			    }
				
			    			    
			    console.log("등록할 주문 데이터:", orderData); // 콘솔에서 데이터 확인
			    console.log("등록할 제품리스트 데이터:", orderProductData.productList); // 콘솔에서 데이터 확인
			    console.log("등록할 제품옵션 데이터:", orderProductData.option); // 콘솔에서 데이터 확인
			    
				 // 사이즈 코드 매핑
				    const sizeMap = {
				        FREE: "SI01",
				        XS: "SI02",
				        S: "SI03",
				        M: "SI04",
				        L: "SI05",
				        XL: "SI06",
				        XXL: "SI07"
				    };

			    for (let i = 0; i < savedProductData.length; i++) {
			        newData.push(savedProductData[i]);

			        console.log(i+1, "번째 데이터", newData[i].quantities);  
					
			        newData[i].quantities.forEach(item => {
			            if (item) {
			                // null이 아닌 값만 필터링하고, "size_" 접두사 제거
			                const filteredEntries = Object.entries(item)
			                    .filter(([key, value]) => value !== null);

			                // productColor 필터링 및 유지
			                const productColorEntry = filteredEntries.find(([key]) => key === "productColor");

			                // 사이즈 정보 필터링 및 변환
			                const sizeEntries = filteredEntries
			                    .filter(([key]) => key.startsWith("size_"))
			                    .map(([key, value]) => [sizeMap[key.replace("size_", "")], value]) // 사이즈 코드 변환

			                // 사이즈 정보가 존재하는 경우에만 push
			                if (sizeEntries.length > 0 && productColorEntry) {
			                    sizeEntries.forEach(([sizeCode, value]) => {
			                        if (sizeCode) { // 변환된 코드가 존재하는 경우만 추가
			                            newData2.push({
			                                productColor: productColorEntry[1], // 색상 정보 추가
			                                sizeCode: sizeCode,  // 변환된 사이즈 코드 추가
			                                quantity: value // 수량 추가
			                            });
			                        }
			                    });
			                }
			            }
			        });
			       
			        console.log("길이 확인", newData.length); 
			        console.log("newData 확인", newData); 

			    }

			    console.log("최종 newData2:", newData2);

			    totalOrderQuantity = newData2.reduce((sum, item) => sum + Number(item.quantity), 0);

			    console.log("모든 제품 총 수량:", totalOrderQuantity);
/* 			    fetch("/order/insertOrder", {
			        method: "POST",
			        headers: {
			            "Content-Type": "application/json"
			        },
			        body: JSON.stringify(orderData)
			    })
			    .then(response => response.json())
			    .then(data => {
			        if (data.success) {
			            alert("주문이 성공적으로 등록되었습니다!");
			            location.reload();  // 페이지 새로고침
			        } else {
			            alert("주문 등록 실패: " + data.message);
			        }
			    })
			    .catch(error => {
			        console.error("주문 등록 오류:", error);
			        alert("주문 등록 중 오류가 발생했습니다.");
			    }); */
			    
			}
	</script>
	</div>
</body>
<!-- 제품추가 모달 -->
<div class="modal fade" id="productCodeModal" tabindex="-1"
	aria-labelledby="productCodeModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="productCodeModalLabel">제품 선택</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal"
					aria-label="Close"></button>
			</div>
			<div class="modal-body">
				<!-- 검색창 -->
				<div class="mb-3">
					<label for="productCodeSearch" class="form-label">제품 코드</label> <input
						type="text" id="productCodeSearch" class="form-control"
						placeholder="제품 코드로 검색" oninput="filterGrid()"> <label
						for="productNameSearch" class="form-label">제품명</label> <input
						type="text" id="productNameSearch" class="form-control"
						placeholder="제품명으로 검색" oninput="filterGrid()">
				</div>
				<div class="card card-body mt-3">
					<div class="row">
						<!-- Toast Grid를 표시할 div 추가 -->
						<div class="col-12 card card-body m-2">
							<p class="fs-5 fw-bolder">제품 선택 모달</p>
							<!-- 그리드를 표시할 div -->
							<div id="productGrid" style="width: 100%;"></div>
						</div>
					</div>
				</div>
				<script th:inline="javascript">
		// Thymeleaf에서 getProductList 데이터를 JSON으로 변환해서 JavaScript로 전달
		const productList = /*[[${getProductList}]]*/[];
		// 전달된 데이터 확인 (콘솔에 출력)
		console.log(productList);
		// Toast Grid 설정
		// --- 제품 추가 그리드 ---
		const grid2 = new tui.Grid(
				{
					el : document.getElementById('productGrid'), // 그리드를 표시할 div
					  scrollX: false, // 가로 스크롤바 비활성화
					  scrollY: false, // 세로 스크롤바 비활성화
					data : productList, // 서버에서 전달된 데이터
					columnOptions : {
						resizable : false
					// 컬럼 크기 조절 가능
					},
					rowHeaders:['rowNum'],
					columns : [
					{ 
						header : '제품코드',
						name : 'productCode',
						align : 'center',	
					},
					{
						header : '제품명',
						name : 'productName',
						align : 'center'
					},
					{
						header : '단가',
						name : 'unitPrice',
						align : 'center'
					},
					],
				});
		const modalElement = document.getElementById('productCodeModal');
		modalElement.addEventListener('show.bs.modal', function () {
		    grid2.refreshLayout(); // 모달이 열리기 전에 그리드 레이아웃 재조정
		});
	</script>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary"
					data-bs-dismiss="modal">닫기</button>
			</div>
		</div>
	</div>
</div>
<!-- 제품코드 모달 끝 -->
<script>
//행 클릭 이벤트
grid2.on('click', function(ev) {
    const clickedRow = ev.rowKey; // 클릭된 행
    const clickedData = grid2.getData()[clickedRow]; // 클릭된 행의 데이터
    // 선택된 제품을 기존 제품 목록에 추가
    addProductToOrderList(clickedData);
    // 모달을 닫기
    $('#productCodeModal').modal('hide');
});
// 제품 목록에 데이터를 추가하는 함수
function addProductToOrderList(product) {
    const currentData = grid.getData();  // 기존의 제품 목록 데이터
    // 새로운 데이터를 추가
    currentData.push({
        no: currentData.length + 1,  // NO (자동 증가)
        productCode: product.productCode,
        productName: product.productName,
        unitPrice: product.unitPrice,
        orderQuantity: totalOrderQuantity,
        orderAmount: product.unitPrice * totalOrderQuantity  // 주문 금액은 단가 * 수량
    });
    
    // 그리드 데이터 갱신
    grid.resetData(currentData);
}
    // 제품 검색 필터링 함수
function filterGrid() {
    const productCode = document.getElementById('productCodeSearch').value.toLowerCase();
    const productName = document.getElementById('productNameSearch').value.toLowerCase();
    // productList 변수를 사용하여 필터링 수행
    const filteredData = productList.filter(product => {
        return product.productCode.toLowerCase().includes(productCode) &&
               product.productName.toLowerCase().includes(productName);
    });
    // 필터링된 데이터를 Toast Grid에 적용
    grid2.resetData(filteredData);
}
    //업체 검색 필터링 함수
function filterCompanyGrid() {
    const companyCode = document.getElementById('companyCodeSearch').value.toLowerCase();  // 업체 코드 검색값
    const companyName = document.getElementById('companyNameSearch').value.toLowerCase();  // 업체명 검색값

    // companyList 변수를 사용하여 필터링 수행
    const filteredData = companyList.filter(company => {
        return company.companyCode.toLowerCase().includes(companyCode) &&
               company.companyName.toLowerCase().includes(companyName);
    });

    // 필터링된 데이터를 회사 그리드에 적용
    companyGrid.resetData(filteredData);
}
    
</script>
<!-- 업체코드 모달 -->
<div class="modal fade" id="companyCodeModal" tabindex="-1"
	aria-labelledby="companyCodeModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="companyCodeModalLabel">업체 선택</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal"
					aria-label="Close"></button>
			</div>
			<div class="modal-body">
				<!-- 업체코드 , 업체명 검색 -->
				<input type="text" id="companyCodeSearch" class="form-control mb-2"
					placeholder="업체코드로 검색" oninput="filterCompanyGrid()"> <input
					type="text" id="companyNameSearch" class="form-control mb-2"
					placeholder="업체명으로 검색" oninput="filterCompanyGrid()">

				<!-- 예시: 업체코드 리스트 -->
				<div class="card card-body mt-3">
					<div class="row">
						<!-- Toast Grid를 표시할 div 추가 -->
						<div class="col-12 card card-body m-2">
							<p class="fs-5 fw-bolder">업체 선택 모달</p>
							<!-- 그리드를 표시할 div -->
							<div id="companyGrid" style="width: 100%;"></div>
						</div>
					</div>
				</div>
				<script th:inline="javascript">
		// Thymeleaf에서 getCompanyList 데이터를 JSON으로 변환해서 JavaScript로 전달
		const companyList = /*[[${getCompanyList}]]*/[];
		// 전달된 데이터 확인 (콘솔에 출력)
		console.log(companyList);
		// Toast Grid 설정
		// 업체 선택 그리드
		const companyGrid = new tui.Grid(
				{
					el : document.getElementById('companyGrid'), // 그리드를 표시할 div
					  scrollX: false, // 가로 스크롤바 비활성화
					  scrollY: false, // 세로 스크롤바 비활성화
					data : companyList, // 서버에서 전달된 데이터
					columnOptions : {
						resizable : false,
					// 컬럼 크기 조절 가능
					},
					rowHeaders:['rowNum'],
					columns : [
					{ 
						header : '업체코드',
						name : 'companyCode',
						align : 'center',
					},
					{
						header : '업체명',
						name : 'companyName',
						align : 'center'
					},
					{
						header : '업체담당자',
						name : 'companyCharger',
						align : 'center'
					},
					],
				});
		const companyModalElement = document.getElementById('companyCodeModal');
		  companyModalElement.addEventListener('show.bs.modal', function () {
		    companyGrid.refreshLayout(); // 모달이 열리기 전에 그리드 레이아웃 재조정
		  });
		companyGrid.on('click', function(ev) {
		    const clickedRowKey = ev.rowKey; // 클릭된 행의 키
		    const clickedData = companyGrid.getRow(clickedRowKey); // 클릭된 행의 데이터
		    // '주문 등록' 섹션의 입력 필드에 값 설정
		    document.getElementById('companyCode').value = clickedData.companyCode;
		    document.getElementById('company').value = clickedData.companyName;
		    document.getElementById('companyCharger').value = clickedData.companyCharger;
		    // 모달 닫기
		    $('#companyCodeModal').modal('hide');
		});
	</script>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary"
					data-bs-dismiss="modal">닫기</button>
			</div>
		</div>
	</div>
</div>
<!-- 업체코드 모달 끝 -->
<script>
  // 업체코드 모달 열기
  function showCompanyCodeModal() {
	  $('#companyCodeModal').modal('show');
  }
  window.onload = function() {
      document.getElementById('charger').value = '[[${name}]]';
      document.getElementById('empCode').value = '[[${code}]]';
      
      // 오늘 날짜 자동 입력하기
      var today = new Date();
      var year = today.getFullYear();
      var month = (today.getMonth() + 1).toString().padStart(2, '0');
      var day = today.getDate().toString().padStart(2, '0');
      var dateString = year + '-' + month + '-' + day;
      
      // 주문일 input에 오늘 날짜 기본값 설정
      document.getElementById('orderDate').value = dateString;
  };
</script>

<style>
.modal {
	display: block !important; /* Bootstrap 기본 동작 우회 */
	visibility: hidden;
}

.modal.show {
	visibility: visible;
}
</style>
</html>