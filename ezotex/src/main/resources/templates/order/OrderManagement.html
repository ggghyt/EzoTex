<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layouts/layout}" layout:fragment="content">
<head>
<meta charset="UTF-8">
<title>이조텍스SCM</title>
<link rel="stylesheet"
	href="https://uicdn.toast.com/grid/latest/tui-grid.css" />
<script src="https://uicdn.toast.com/grid/latest/tui-grid.js"></script>
<script>
// 인풋 초기화 함수
function resetForm() {
    document.getElementById('companyCode').value = '';
    document.getElementById('company').value = '';
    document.getElementById('companyCharger').value = '';
    document.getElementById('companyTel').value = '';
    document.getElementById('orderDate').value = '';
    document.getElementById('deliveryRequestDeadline').value = '';
    document.getElementById('orderStatus').value = '';
    document.getElementById('remarks').value = '';
}
// 모든 제품의 총 수량 계산
let totalOrderQuantity = 0;


let productCode = "";

let clickedRowKey = "";// 클릭한 행의 키
let clickedData = ""; // 클릭한 행의 데이터
</script>
<style>
.inputbold {
	font-weight: bold;
	color: green;
}
</style>
</head>
<body>
	<h3 class="fs-3 fw-bold m-0">| 주문 등록</h3>
	<br>

	<!-- 등록 모달 -->
	<div class="modal fade" id="registModal" tabindex="-1"
		aria-labelledby="exampleModalLabel" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header" style="height: 20px;">
					<h5 class="modal-title" id="exampleModalLabel"
						style="font-size: 15px;">등록 확인</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal"
						aria-label="Close"></button>
				</div>
				<div class="modal-body"
					style="text-align: center; padding: 44px; padding-bottom: 10px;">
					<div>
						<img src="/images/modal/regist.png" alt="등록확인이미지"
							style="width: 84px; height: 84px;">
					</div>
					<div>
						<p style="margin-top: 12px; font-size: 21px; font-weight: bold;">알림</p>
						<p>내용을 등록하시겠습니까?</p>
					</div>
				</div>
				<div class="modal-footer regist"
					style="display: flex; justify-content: center; border-top: none; padding-bottom: 45px;">
					<!---->
					<button type="button" id="resiBtn"
						class="btn btn-outline-primary checkBtn" data-bs-dismiss="modal">등록</button>
					<button type="button" class="btn btn-secondary denyBtn"
						data-bs-dismiss="modal">취소</button>
				</div>
			</div>
		</div>
	</div>



	<div class="card card-body m-2 bg-secondary">
		<div class="row">

			<p class="fs-5 fw-bolder m-1">주문 정보</p>
			<table class="table table-borderless">
				<tbody>
					<!-- 첫 번째 줄 -->
					<tr>
						<td class="col-auto"><label class="col-form-label">주문
								담당자</label> <input type="text" id="charger"
							class="form-control inputbold" readonly></td>
						<td class="col-auto"><label class="col-form-label">사원코드</label>
							<input type="text" id="empCode" class="form-control inputbold"
							readonly></td>
						<td class="col-auto"><label class="col-form-label">주문일</label>
							<input type="date" id="orderDate" class="form-control inputbold"
							readonly></td>
						<td class="col-auto"><label class="col-form-label">납기일</label>
							<input type="date" id="deliveryRequestDeadline"
							class="form-control inputbold" style="cursor: pointer;"
							onclick="this.showPicker()"></td>
					</tr>
					<!-- 두 번째 줄 -->
					<tr>
						<td class="col-auto"><label class="col-form-label">업체코드</label>
							<input type="text" id="companyCode"
							class="form-control inputbold" placeholder="눌러서 업체선택"
							onclick="showCompanyCodeModal()" style="cursor: pointer;"></td>
						<td class="col-auto"><label class="col-form-label">업체명</label>
							<input type="text" id="company" class="form-control inputbold"
							readonly></td>
						<td class="col-auto"><label class="col-form-label">업체
								담당자</label> <input type="text" id="companyCharger"
							class="form-control inputbold" readonly></td>
						<td class="col-auto"><label class="col-form-label">업체
								전화번호</label> <input type="tel" id="companyTel"
							class="form-control inputbold" readonly></td>
					</tr>
					<tr>
						<td colspan="4"><label class="col-form-label">비고</label> <input
							type="text" id="remarks" class="form-control inputbold"
							placeholder="특이사항을 입력해주세요."></td>
					</tr>
				</tbody>
			</table>
			<div class="d-flex justify-content-center gap-2">
				<button type="button" class="btn btn-secondary btn-sm mt-3"
					onclick="resetForm()">초기화</button>
			</div>
		</div>
	</div>
	<div class="card card-body mt-3">

		<div class="row align-items-center">
			<div class="fs-5 fw-bolder">제품 목록</div>
			<div class="d-flex justify-content-end gap-2">
				<button type="button" class="btn btn-info btn-sm"
					data-bs-toggle="modal" data-bs-target="#productCodeModal">제품
					추가</button>
				<button id="btnDelete" class="btn btn-danger btn-sm">삭제</button>
			</div>
			<p>
		</div>
		<!-- //제품 목록 그리드 -->
		<div id="grid" style="width: 100%;"></div>
		<script>
		document.getElementById('companyTel').addEventListener('input', function () {
		    let phoneValue = this.value.replace(/\D/g, ''); // 숫자 외의 문자는 제거

		    // 길이가 11을 넘으면 11자리까지만 입력 받도록 자르기
		    if (phoneValue.length > 11) {
		        phoneValue = phoneValue.substring(0, 11);
		    }

		    // 하이픈을 자동으로 추가
		    if (phoneValue.length <= 3) {
		        this.value = phoneValue;
		    } else if (phoneValue.length <= 7) {
		        this.value = phoneValue.replace(/(\d{3})(\d{1,4})/, '$1-$2');
		    } else {
		        this.value = phoneValue.replace(/(\d{3})(\d{4})(\d{1,4})/, '$1-$2-$3');
		    }

		    // 전화번호가 완성되지 않았거나 길이가 13자 미만일 때 경고만 표시
		    if (this.value.length === 13 && !/^(\d{3}-\d{4}-\d{4})$/.test(this.value)) {
		    	failToast("전화번호 형식이 잘못되었습니다. 올바른 형식: 000-0000-0000");
		    }
		});
		
		
    // 기본 옵션 설정
    const grid = new tui.Grid({
      el: document.getElementById('grid'), // 그리드를 표시할 엘리먼트
      scrollX: false, // 가로 스크롤바 비활성화
      scrollY: false, // 세로 스크롤바 비활성화
      rowHeight: 'auto',  // 행 높이를 자동으로 조정
      rowHeaders: ['checkbox',{ type: 'rowNum', header: 'NO' }],
      columns: [  // 컬럼 설정 (빈 컬럼으로 초기화)
        {
          header: '제품 코드',
          name: 'productCode',
          align: 'center',
        },
        {
          header: '제품명',
          name: 'productName',
          align: 'center',
          formatter: function({ value }) {
              return `<strong>${value}</strong>`; // 글자를 굵게 설정
          }
        },
        {
          header: '단가',
          name: 'unitPrice',
          align: 'right',
          formatter: row => numberFormatter(row.value) // 천단위 콤마 포맷 적용
        },
        {
          header: '주문 수량',
          name: 'orderQuantity',
          align: 'right',
          formatter: row => numberFormatter(row.value),
        },
        {
          header: '주문 금액',
          name: 'orderAmount',
          align: 'right',
          formatter: row => numberFormatter(row.value),
        }
      ],
	    pageOptions: {
	        useClient: true, // 페이징을 위해 필요
	        perPage: 3
      	},
      data: [], // 빈 데이터로 초기화
    });
    
	let lastClicked = null; // 페이지 이동 시에도 이전 선택 기억하기 위함.
    
    grid.on('click', function(ev) {
    	grid.removeRowClassName(lastClicked, 'bg-blue'); // 이전 선택 행 배경색 삭제
    	grid.addRowClassName(ev.rowKey, 'bg-blue'); // 선택된 행 배경색 추가
	    lastClicked = ev.rowKey; // 선택된 행 기억
    	
        clickedRowKey = ev.rowKey; // 클릭한 행의 키
        clickedData = grid.getRow(clickedRowKey); // 클릭한 행의 데이터
        
        console.log("cR",clickedRowKey);
        console.log("cD",clickedData);
        
        // "선택한 제품" 입력 필드에 값 설정
        document.getElementById('selectProductCode').value = clickedData.productCode;
        document.getElementById('selectProductName').value = clickedData.productName;
        
        // 실제 단가는 콤마 없이 설정
        const unitPrice = clickedData.unitPrice;
        document.getElementById('selectUnitPrice').value = clickedData.unitPrice;
        
        // 화면에 보일 때만 콤마를 추가
        document.getElementById('selectUnitPrice').value = formatNumberWithComma(unitPrice);
        
        productCode = clickedData.productCode;
        console.log("ㅍㄹㄷㅌ",productCode);
        
        // 이미 저장된 수량 데이터가 있는지 확인
        const savedData = savedProductData.find(data => data.productCode === productCode);
        if (savedData) {
            // 저장된 데이터가 있으면 옵션 그리드에 데이터 다시 설정
            optionGrid.resetData(savedData.quantities);
            
            console.log(savedProductData);
            console.log(savedData);
        } else {
            // 저장된 데이터가 없으면 빈 데이터로 초기화
            optionGrid.resetData([]);
	        fetch(`/order/ProductOption?productCode=${productCode}`)  // 서버에서 색상, 사이즈 데이터를 가져옴
	            .then(response => response.json())
	            .then(data => {
	        console.log(productCode , "서버연결되는지" , data);
	        optionGrid.resetData(data);
	        });
        }

    });
    
    document.getElementById("btnDelete").addEventListener("click", function () {
    	  const checkedRows = grid.getCheckedRows(); // 선택된 행 가져오기
    	  const rowKeys = checkedRows.map(row => row.rowKey); // 행 키 배열 만들기
    	  const deletedProductCodes = checkedRows.map(row => row.productCode); // 삭제할 제품 코드 가져오기
    	  
    	  
    	  console.log("삭제할 행 키:", rowKeys); // 삭제할 행 확인용 로그
    	  rowKeys.forEach(rowKey => grid.removeRow(rowKey)); // 선택된 행 삭제
    	  
    	    rowKeys.forEach(rowKey => grid.removeRow(rowKey));
    	  
    	    savedProductData = savedProductData.filter(data => !deletedProductCodes.includes(data.productCode));

    	    console.log("삭제 후 savedProductData:", savedProductData);
    	    
    	    // newData2(최종 등록 데이터) 삭제
    	    newData2 = newData2.filter(data => !deletedProductCodes.includes(data.productCode));
    	    
    	    console.log("삭제 후 newData2:", newData2);
    	  
    	});
    
  </script>
	</div>
	<div class="row">
		<div class="col-5 card card-body m-2">
			<p class="fs-5 fw-bolder">제품 옵션</p>
			<table class="table mt-3">
				<tr class="d-flex">
					<td class="d-flex align-items-center mr-3"><label
						class="col-form-label mr-3">제품코드</label> <input type="text"
						id="selectProductCode" class="form-control"
						style="width: 200px; margin-left: 10px" placeholder="제품코드"
						readonly></td>
					<td class="d-flex align-items-center"><label
						class="col-form-label mr-3">제품명</label> <input type="text"
						id="selectProductName" class="form-control"
						style="width: 200px; margin-left: 10px" placeholder="제품명" readonly></td>
					<td class="d-flex align-items-center"><label
						class="col-form-label mr-3">단가</label> <input type="text"
						id="selectUnitPrice" class="form-control"
						style="width: 200px; margin-left: 10px; text-align: right;"
						placeholder="단가" readonly></td>
					<td class="d-flex align-items-center"><label
						class="col-form-label mr-3">주문 수량 총합</label> <input type="text"
						id="orderQuantity" class="form-control"
						style="width: 200px; margin-left: 10px; text-align: right;"
						placeholder="총 수량" readonly></td>
					<td class="d-flex align-items-center"><label
						class="col-form-label mr-3">주문 금액 합계</label> <input type="text"
						id="orderAmount" class="form-control"
						style="width: 200px; margin-left: 10px; text-align: right;"
						placeholder="총 금액" readonly></td>
				</tr>
			</table>
			<div id="save">
				<button type="button" class="btn btn-info"
					onclick="saveProductData()">옵션 저장</button>
				<p>
			</div>
			<div id="productOption" class="d-flex justify-content">
				<p>
			</div>
			<p>
			<table class="table mt-3">
				<tr class="d-flex">

				</tr>
			</table>
			<div>
				<button type="button" id="regibtn" class="btn btn-primary registBtn"
					onclick="insertOrder()">주문 등록</button>
			</div>

		</div>
		<script th:inline="javascript">
		// Thymeleaf에서 productOption 데이터를 JSON으로 변환해서 JavaScript로 전달
		const productOption = /*[[${getProductOption}]]*/[];
		// 전달된 데이터 확인 (콘솔에 출력)
		// Toast Grid 설정
		// --- 제품 옵션 그리드 ---
		const optionGrid = new tui.Grid(
				{
					el : document.getElementById('productOption'), // 그리드를 표시할 div
					  scrollX: false, // 가로 스크롤바 비활성화
					  scrollY: false, // 세로 스크롤바 비활성화
					data : 
						productOption,// 서버에서 전달된 데이터
						api:{
							modifyData : { url: '/order/insertOrder' , method: 'POST' , headers} ,
						},
					columnOptions : {
						resizable : true
						
					// 컬럼 크기 조절 가능
					},
					columns : [
					{
						header : '제품코드',
						name : productCode,
						hidden:true
					}
						,
					{ 
						header : '색상/사이즈',
						name : 'productColor',
						align : 'center',	
			            width: 220 // 고정 크기 설정

					},
					{ 
						header : 'XS',
						name : 'size_XS',
						align : 'center',	
						editor: 'text',
			            width: 220

					},
					{ 
						header : 'S',
						name : 'size_S',
						align : 'center',	
						editor: 'text',
			            width: 220

					},
					{ 
						header : 'M',
						name : 'size_M',
						align : 'center',	
						editor: 'text',
			            width: 220

					},
					{ 
						header : 'L',
						name : 'size_L',
						align : 'center',	
						editor: 'text',
			            width: 220

					},
					{ 
						header : 'XL',
						name : 'size_XL',
						align : 'center',	
						editor: 'text',
			            width: 220
					},
					{ 
						header : 'FREE SIZE',
						name : 'size_FREE',
						align : 'center',	
						editor: 'text',
			            width: 220
					},
					],
					width: 1540,
				    bodyHeight: 100, 
				    autoWidth: true  // 자동 너비 조절
				});
		optionGrid.on('editingFinish', ev => {
		    const { rowKey, columnName, value } = ev;

		    // 입력값이 0보다 작은 경우 처리
		    if (Number(value) < 1) {
		    	failToast("1보다 적은 수는 입력할 수 없습니다.");

		        // 값을 0으로 변경하여 음수 입력 방지
		        optionGrid.setValue(rowKey, columnName, 1);
		    }
		    
		    // 숫자가 아닌 값 입력 방지
		    if (!/^\d+$/.test(value)) {  
		    	failToast("숫자만 입력할 수 있습니다.");
		        optionGrid.setValue(rowKey, columnName, 1); // 기본값 1로 설정
		        return;
		    }
		});
		// 제품별로 입력된 수량을 저장할 배열
		let savedProductData = [];

		// 수량을 저장하는 함수
		function saveProductData() {
			
			newData2 = [];

		    let selectedProductCode = document.getElementById('selectProductCode').value;  // 선택된 제품 코드
		    let selectedUnitPrice= document.getElementById('selectUnitPrice').value;  // 선택된 제품 단가
		    
		    // 단가에서 콤마 제거
		    selectedUnitPrice = selectedUnitPrice.replace(/,/g, ''); // 콤마 제거
		    selectedUnitPrice = parseFloat(selectedUnitPrice); // 숫자 변환
		    
		    console.log(selectedProductCode);
		    console.log(selectedUnitPrice);
		    
		    const rows = optionGrid.getData();  // 제품 옵션 그리드 데이터
		    
		    // 사이즈 입력 여부 확인
		    const hasSizeInput = rows.some(row => 
		        row.size_XS || row.size_S || row.size_M || row.size_L || row.size_XL || row.size_FREE
		    );
		    
		    if (!hasSizeInput) {
		    	failToast('사이즈를 입력해주세요.');
		        return;
		    }
			
		    // 수량구하기
			const qyData = {
			    quantities: rows.map(row => {
			        return {
			            size_XS: (row.size_XS !== null && row.size_XS !== 0) ? row.size_XS : undefined,  // XS 사이즈 수량
			            size_S: (row.size_S !== null && row.size_S !== 0) ? row.size_S : undefined,  // S 사이즈 수량
			            size_M: (row.size_M !== null && row.size_M !== 0) ? row.size_M : undefined,  // M 사이즈 수량
			            size_L: (row.size_L !== null && row.size_L !== 0) ? row.size_L : undefined,  // L 사이즈 수량
			            size_XL: (row.size_XL !== null && row.size_XL !== 0) ? row.size_XL : undefined,  // XL 사이즈 수량
			            size_FREE: (row.size_FREE !== null && row.size_FREE !== 0) ? row.size_FREE : undefined,  // FREE 사이즈 수량
			        };
			    }).map(row => {
			        // null 또는 undefined인 값들을 제외한 객체만 반환
			        return Object.fromEntries(Object.entries(row).filter(([key, value]) => value !== undefined));
			    })
			};
			
			// 수량 합산
			let totalQuantity = 0;
			
			qyData.quantities.forEach(row => {
			    // 각 사이즈 값들을 숫자로 변환하여 합산
			    totalQuantity += Object.values(row).reduce((sum, value) => {
			        const numericValue = Number(value);  // 문자열을 숫자로 변환
			        return sum + (isNaN(numericValue) ? 0 : numericValue);  // 숫자가 아닌 값은 0으로 처리
			    }, 0);
			});
			
			console.log('Total Quantity:', totalQuantity);  // 합산된 수량 출력
		    /* document.getElementById('orderQuantity').value = totalQuantity; */
			grid.setValue(clickedRowKey,"orderQuantity",totalQuantity);
			grid.setValue(clickedRowKey,"orderAmount",totalQuantity*selectedUnitPrice);
			
			// amount구하기
			
		    // 수량 데이터를 배열에 저장
		    const productData = {
		        productCode: selectedProductCode,
		        quantities: rows.map(row => ({
		        	productCode: selectedProductCode,
		        	productColor: row.productColor,  // 색상
		            size_XS: row.size_XS,  // XS 사이즈 수량
		            size_S: row.size_S,  // S 사이즈 수량
		            size_M: row.size_M,  // M 사이즈 수량
		            size_L: row.size_L,  // L 사이즈 수량
		            size_XL: row.size_XL,  // XL 사이즈 수량
		            size_FREE: row.size_FREE,  // FREE 사이즈 수량
		            unitPrice: selectedUnitPrice
		        })),
		            orderQuantity : totalQuantity // 총 수량
		    };			
				
			console.log("productData 출력",productData);
		    // 배열에 해당 제품 데이터 추가 (기존에 있으면 업데이트)
		    const index = savedProductData.findIndex(data => data.productCode === selectedProductCode);
		    console.log(index,"index 확인");
		    if (index > -1) {
		        savedProductData[index] = productData;  // 기존 데이터 업데이트
		    } else {
		        savedProductData.push(productData);  // 새로 추가
		    }

		    console.log('저장된 제품 데이터:', savedProductData);
		    
		    
		    
		    
		    const sizeMap = {
			        FREE: "SI01",
			        XS: "SI02",
			        S: "SI03",
			        M: "SI04",
			        L: "SI05",
			        XL: "SI06",
			        XXL: "SI07"
			    };
		    
		    newData = [];
		    for (let i = 0; i < savedProductData.length; i++) {
		    	
		        newData.push(savedProductData[i]);
		    
		        console.log("savedProductData",savedProductData);  

		        console.log(i+1, "번째 데이터", newData[i].quantities);  
				
		        newData[i].quantities.forEach(item => {
		            if (item) {
		                // null이 아닌 값만 필터링하고, "size_" 접두사 제거
		                const filteredEntries = Object.entries(item)
		                    .filter(([key, value]) => value !== null);

		                // productColor 필터링 및 유지
		                const productColorEntry = filteredEntries.find(([key]) => key === "productColor");

		                // 사이즈 정보 필터링 및 변환
		                const sizeEntries = filteredEntries
		                    .filter(([key]) => key.startsWith("size_"))
		                    .map(([key, value]) => [sizeMap[key.replace("size_", "")], value]) // 사이즈 코드 변환

		                // 사이즈 정보가 존재하는 경우에만 push
		                if (sizeEntries.length > 0 && productColorEntry) {
		                    sizeEntries.forEach(([sizeCode, value]) => {
		                        if (sizeCode) { // 변환된 코드가 존재하는 경우만 추가
		                            newData2.push({
		                            	productCode: item.productCode,
		                                productColor: productColorEntry[1], // 색상 정보 추가
		                                sizeCode: sizeCode,  // 변환된 사이즈 코드 추가
		                                quantity: value, // 수량 추가
		                                unitPrice: item.unitPrice
		                            });
		                        }
		                    });
		                }
		            }
		        });
		       
		        console.log("길이 확인", newData.length); 
		        console.log("newData 확인", newData); 

		    }
		    console.log("최종 newData2:", newData2);
		    
		    // 주문총수량 총합 구하기
		    const orderUnit = grid.getData().map(row => row.orderQuantity); // 주문 금액 컬럼 값 구하기
		    const unitSum = orderUnit.reduce((acc, value) => acc + value, 0); // 주문 금액 합 구하기

		    console.log("열 데이터 출력:", orderUnit);
		    console.log("총합:", unitSum);
		    document.getElementById('orderQuantity').value = unitSum.toLocaleString();
		    
		    
		    // 주문금액 총합 구하기
		    const orderMoney = grid.getData().map(row => row.orderAmount); // 주문 금액 컬럼 값 구하기
		    const moneySum = orderMoney.reduce((acc, value) => acc + value, 0); // 주문 금액 합 구하기

		    console.log("열 데이터 출력:", orderMoney);
		    console.log("총합:", moneySum);
		    document.getElementById('orderAmount').value = moneySum.toLocaleString();

		    
		}
		
		// 제품 데이터 삭제하는 함수
		function deleteProductData() {
		    const checkedRows = grid.getCheckedRows(); // 체크된 행 가져오기
		
		    // 체크된 제품의 productCode를 추출하여 삭제
		    const checkedProductCodes = checkedRows.map(row => row.productCode);
		    savedProductData = savedProductData.filter(data => !checkedProductCodes.includes(data.productCode));
		
		    console.log('삭제 후 제품 데이터:', savedProductData);
		    
		    // 선택한 제품 입력 필드 초기화
		    document.getElementById('selectProductCode').value = '';
		    document.getElementById('selectProductName').value = '';
		    document.getElementById('selectUnitPrice').value = '';
		    
		    // 제품 옵션 그리드 초기화
		    optionGrid.resetData([]);
		    
		    // 삭제된 데이터 반영
		    grid.removeRows(checkedRows.map(row => row.rowKey));
		    
		    // 주문총수량 총합 다시 계산
		    const orderUnit = grid.getData().map(row => row.orderQuantity || 0); 
		    const unitSum = orderUnit.reduce((acc, value) => acc + value, 0);
		    
		    console.log("열 데이터 출력 (삭제 후 주문 수량):", orderUnit);
		    console.log("총합 (삭제 후 주문 수량):", unitSum);
		    document.getElementById('orderQuantity').value = unitSum.toLocaleString();

		    // 주문금액 총합 다시 계산
		    const orderMoney = grid.getData().map(row => row.orderAmount || 0);
		    const moneySum = orderMoney.reduce((acc, value) => acc + value, 0);

		    console.log("열 데이터 출력 (삭제 후 주문 금액):", orderMoney);
		    console.log("총합 (삭제 후 주문 금액):", moneySum);
		    document.getElementById('orderAmount').value = moneySum.toLocaleString();
		
		    // 그리드 다시 렌더링 (필요한 경우)
		    grid.refreshLayout();
		}

		// 삭제 버튼 이벤트 리스너 추가
		document.getElementById('btnDelete').addEventListener('click', deleteProductData);

		  let newData = [];		
		  let newData2 = [];
		  // 등록이벤트
		  function insertOrder(productCode) {
		        if (!companyCode.value.trim()) {
		        	failToast("업체를 선택해야 합니다.");
		            return false;
		        }
		        
			    const orderQuantity = document.getElementById("orderQuantity");
			    const orderAmount = document.getElementById("orderAmount");
			    
			    console.log("orderQuantity",document.getElementById("orderQuantity").value);
			    console.log("orderAmount",document.getElementById("orderAmount").value);
			    
		        if (!orderQuantity.value || orderQuantity.value == 0 || !orderAmount.value || orderAmount.value == 0) {
		        	failToast("등록할 제품이 없습니다.");
		            return false;
	        	}
		        
		        // newData2가 비어있으면 등록 불가
		        if (newData2.length === 0) {
		        	failToast("등록할 제품이 없습니다.");
		            return false;
		        }
			  
			  
			  
				let resiModal = new bootstrap.Modal(document.getElementById('registModal'));
				resiModal.show();
				
				resiBtn.addEventListener("click" , function () {
					
					
			    const orderData = {
/* 			    	productOrderCode : document.getElementById("productOrderCode").value, // 주문코드 */
			        charger: document.getElementById("charger").value, // 담당자
			        empCode: document.getElementById("empCode").value, // 담당자 사원코드
			        companyCode: document.getElementById("companyCode").value, // 업체코드
			        company: document.getElementById("company").value, // 업체
			        companyRepresentative: document.getElementById("companyCharger").value, // 업체담당자
			        companyTel: document.getElementById("companyTel").value, // 업체담당자 전화번호
			        deliveryRequestDeadline: document.getElementById("deliveryRequestDeadline").value, // 납기일
			        orderStatus: document.getElementById("orderStatus").value || "OR01", // 주문 상태 - 기본값 : 대기
			        remarks: document.getElementById("remarks").value, // 비고 
			        amount: Number(orderAmount.value.replace(/,/g, '')), // 콤마 제거하고 숫자로 변환
			    };
			    const orderProductData = {
		    			//productOrderCode : document.getElementById("productOrderCode").value, // 주문코드
	                    option: newData2 // 배열로 감싸기	    		
			    }
				
			    			    
			    console.log("등록할 제품 데이터:", orderProductData); // 콘솔에서 데이터 확인
			    console.log("productList 데이터:", productList); // 콘솔에서 데이터 확인
			    console.log("option 데이터:", orderProductData.option); // 콘솔에서 데이터 확인
			    
				 // 사이즈 코드 매핑
				    const sizeMap = {
				        FREE: "SI01",
				        XS: "SI02",
				        S: "SI03",
				        M: "SI04",
				        L: "SI05",
				        XL: "SI06",
				        XXL: "SI07"
				    };

			    	console.log("savedProductData",savedProductData.length);
			    	newData = [];
			    	newData2 = [];
			    for (let i = 0; i < savedProductData.length; i++) {
			        newData.push(savedProductData[i]);
			    
			        console.log("savedProductData",savedProductData);  

			        console.log(i, "번째 데이터", newData[i].quantities);  
					
			        newData[i].quantities.forEach(item => {
			            if (item) {
			                // null이 아닌 값만 필터링하고, "size_" 접두사 제거
			                const filteredEntries = Object.entries(item)
			                    .filter(([key, value]) => value !== null);

			                // productColor 필터링 및 유지
			                const productColorEntry = filteredEntries.find(([key]) => key === "productColor");

			                // 사이즈 정보 필터링 및 변환
			                const sizeEntries = filteredEntries
			                    .filter(([key]) => key.startsWith("size_"))
			                    .map(([key, value]) => [sizeMap[key.replace("size_", "")], value]) // 사이즈 코드 변환
			                    
			                
			                // 사이즈 정보가 존재하는 경우에만 push
			                if (sizeEntries.length > 0 && productColorEntry) {
			                    sizeEntries.forEach(([sizeCode, value]) => {
			                        if (sizeCode) { // 변환된 코드가 존재하는 경우만 추가
			                            newData2.push({
			                            	productCode: item.productCode,
			                                productColor: productColorEntry[1], // 색상 정보 추가
			                                sizeCode: sizeCode,  // 변환된 사이즈 코드 추가
			                                quantity: value, // 수량 추가
			                                unitPrice: item.unitPrice
			                            });
			                        }
			                    });
			                }	
			            }
			        });
			       
			        console.log("길이 확인", newData.length); 
			        console.log("newData 확인", newData); 

			    }

			    console.log("최종 newData2:", newData2);

/* 			    totalOrderQuantity = newData2.reduce((sum, item) => sum + Number(item.quantity), 0);

			    console.log("모든 제품 총 수량:", totalOrderQuantity); */
			    
 			    fetch(`/order/insertOrder`, {
			        method: 'POST',
			        headers: {
			        	...headers,
			            "Content-Type": "application/json"
			        },
			        body: JSON.stringify(orderData),
			    })
			    .then(rep => rep.json())
			    .then(result => {
			        if (!result || !result.productOrderCode) {
			            throw new Error("주문 코드가 없습니다.");
			        }
			    	// 주문코드 추가
			    	orderProductData.productOrderCode = result.productOrderCode;
		        	fetch(`/order/insertProductOrder`, {
				        method: 'POST',
				        headers: {
				        	...headers,
				            "Content-Type": "application/json"
				        },
				        body: JSON.stringify(orderProductData),
				    })
				    .then(rep => rep.json())
				    .then(data => {
				        if (data !== true) {
				            throw new Error("주문 등록 실패");
				        }
				        console.log("주문 등록 성공:", data);
				        location.reload();
				    })
			    })
			    .catch(error => {
			        console.error("주문 등록 오류:", error);
			        failToast("주문 등록 중 오류가 발생했습니다.");
			        return;
			    });
			    
				})
			}
	</script>
	</div>
</body>
<!-- 제품추가 모달 -->
<div class="modal fade" id="productCodeModal" tabindex="-1"
	aria-labelledby="productCodeModalLabel" aria-hidden="true">
	<div class="modal-dialog" style="max-width: 600px; width: 80%;">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="productCodeModalLabel">제품 선택</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal"
					aria-label="Close"></button>
			</div>
			<div class="modal-body">
				<!-- 제품 검색창 -->
				<div class="card card-body mt-3 bg-secondary">
					<h3>검색</h3>
					<table class="table mt-3">
						<tbody>
							<!-- 첫 번째 줄 -->
							<tr>
								<td class="col-auto"><label class="col-form-label">제품코드</label></td>
								<td class="col-auto"><input type="text"
									id="searchProductCode" class="form-control"></td>
								<td class="col-auto"><label class="col-form-label">제품명</label></td>
								<td class="col-auto"><input type="text"
									id="searchProductName" class="form-control"></td>
							</tr>
						</tbody>
					</table>
					<div class="text-center mt-3">
						<button class="btn btn-warning mag-glass-btn"
							onclick="searchProductList()">
							<i class="fa-solid fa-magnifying-glass icon-left"
								style="color: #ffffff;"></i>
						</button>
						<button class="btn btn-secondary mag-glass-btn"
							onclick="resetCondition()">
							<i class="fa-solid fa-repeat icon-left" style="color: #ffffff;"></i>
						</button>
					</div>
				</div>
				<div class="card card-body mt-3">
					<div class="row">
						<!-- Toast Grid를 표시할 div 추가 -->
						<p class="fs-5 fw-bolder">제품 선택</p>
						<!-- 그리드를 표시할 div -->
						<div id="productGrid" style="width: 100%;"></div>
					</div>
				</div>
				<script th:inline="javascript">
		// Thymeleaf에서 getProductList 데이터를 JSON으로 변환해서 JavaScript로 전달
		const productList = /*[[${getProductList}]]*/[];
		// 전달된 데이터 확인 (콘솔에 출력)
		console.log(productList);
		// Toast Grid 설정
		// --- 제품 추가 그리드 ---
		const grid2 = new tui.Grid(
				{
					el : document.getElementById('productGrid'), // 그리드를 표시할 div
					  scrollX: false, // 가로 스크롤바 비활성화
					  scrollY: false, // 세로 스크롤바 비활성화
					data : productList, // 서버에서 전달된 데이터
					columnOptions : {
						resizable : false
					// 컬럼 크기 조절 가능
					},
					rowHeaders:['rowNum'],
					columns : [
					{ 
						header : '제품코드',
						name : 'productCode',
						align : 'center',	
					},
					{
						header : '제품명',
						name : 'productName',
						align : 'center',
						width: 250,
			            formatter: function({ value }) {
			                return `<strong>${value}</strong>`; // 글자를 굵게 설정
			            }
					},
					{
						header : '단가',
						name : 'unitPrice',
						align : 'right',
				        formatter: function({ value }) {
				            return value ? value.toLocaleString() : '0';
				        },
					},
					],
				    pageOptions: {
				        useClient: true, // 페이징을 위해 필요
				        perPage: 5
			      	},
				});
		const modalElement = document.getElementById('productCodeModal');
		modalElement.addEventListener('show.bs.modal', function () {
		    grid2.refreshLayout(); // 모달이 열리기 전에 그리드 레이아웃 재조정
		});
	</script>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary"
					data-bs-dismiss="modal">닫기</button>
			</div>
		</div>
	</div>
</div>
<!-- 제품코드 모달 끝 -->
<script>
// 모달 행 클릭 이벤트
grid2.on('click', function(ev) {
    const clickedRow = ev.rowKey; // 클릭된 행
    const clickedData = grid2.getData()[clickedRow]; // 클릭된 행의 데이터
    // 선택된 제품을 기존 제품 목록에 추가
    addProductToOrderList(clickedData);
    // 모달을 닫기
    $('#productCodeModal').modal('hide');
});
// 제품 목록에 데이터를 추가하는 함수
function addProductToOrderList(product) {
    const currentData = grid.getData();  // 기존의 제품 목록 데이터
    
    // 제품이 이미 목록에 있는지 확인 (중복 체크)
    const isDuplicate = currentData.some(item => item.productCode === product.productCode);

    if (isDuplicate) {
    	failToast('이 제품은 이미 목록에 있습니다.');
        return;  // 중복된 제품은 추가하지 않음
    }
    
    // 새로운 데이터를 추가
    currentData.push({
        no: currentData.length + 1,  // NO (자동 증가)
        productCode: product.productCode,
        productName: product.productName,
        unitPrice: product.unitPrice,
        orderQuantity: totalOrderQuantity,
        orderAmount: product.unitPrice * totalOrderQuantity  // 주문 금액은 단가 * 수량
    });
    
    // 그리드 데이터 갱신
    grid.resetData(currentData);
}
    
</script>
<!-- 업체코드 모달 -->
<div class="modal fade" id="companyCodeModal" tabindex="-1"
	aria-labelledby="companyCodeModalLabel" aria-hidden="true">
	<div class="modal-dialog" style="max-width: 600px; width: 80%;">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="companyCodeModalLabel">업체 선택</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal"
					aria-label="Close"></button>
			</div>
			<div class="modal-body">
				<!-- 업체 검색창 -->
				<div class="card card-body mt-3 bg-secondary"
					style="background-color: #d3d3d3;">
					<h3>검색</h3>
					<table class="table mt-3">
						<tbody>
							<tr>
								<td class="col-auto"><label class="col-form-label">업체코드</label></td>
								<td class="col-auto"><input type="text"
									id="searchCompanyCode" class="form-control"></td>
								<td class="col-auto"><label class="col-form-label">업체명</label></td>
								<td class="col-auto"><input type="text"
									id="searchCompanyName" class="form-control"></td>
							</tr>
						</tbody>
					</table>
					<div class="text-center mt-3">
						<button class="btn btn-warning mag-glass-btn"
							onclick="searchCompanyList()">
							<i class="fa-solid fa-magnifying-glass icon-left"
								style="color: #ffffff;"></i>
						</button>
						<button class="btn btn-secondary mag-glass-btn"
							onclick="resetCompanyCondition()">
							<i class="fa-solid fa-repeat icon-left" style="color: #ffffff;"></i>
						</button>
					</div>
				</div>
				<!-- 예시: 업체코드 리스트 -->
				<div class="card card-body mt-3">
					<div class="row">
						<!-- Toast Grid를 표시할 div 추가 -->
						<p class="fs-5 fw-bolder">업체 선택</p>
						<!-- 그리드를 표시할 div -->
						<div id="companyGrid" style="width: 100%;"></div>
					</div>
				</div>
				<script th:inline="javascript">
		// Thymeleaf에서 getCompanyList 데이터를 JSON으로 변환해서 JavaScript로 전달
		const companyList = /*[[${getCompanyList}]]*/[];
		// 전달된 데이터 확인 (콘솔에 출력)
		console.log(companyList);
		// Toast Grid 설정
		// 업체 선택 그리드
		const companyGrid = new tui.Grid(
				{
					el : document.getElementById('companyGrid'), // 그리드를 표시할 div
					  scrollX: false, // 가로 스크롤바 비활성화
					  scrollY: false, // 세로 스크롤바 비활성화
					data : companyList, // 서버에서 전달된 데이터
					columnOptions : {
						resizable : false,
					// 컬럼 크기 조절 가능
					},
					rowHeaders:['rowNum'],
					columns : [
					{ 
						header : '업체코드',
						name : 'companyCode',
						align : 'center',
					},
					{
						header : '업체명',
						name : 'companyName',
						align : 'center',
			            formatter: function({ value }) {
			                return `<strong>${value}</strong>`; // 글자를 굵게 설정
			            }
					},
					{
						header : '업체담당자',
						name : 'companyCharger',
						align : 'center'
					},
					],
				    pageOptions: {
				        useClient: true, // 페이징을 위해 필요
				        perPage: 5
			      	},
				});
		const companyModalElement = document.getElementById('companyCodeModal');
		  companyModalElement.addEventListener('show.bs.modal', function () {
		    companyGrid.refreshLayout(); // 모달이 열리기 전에 그리드 레이아웃 재조정
		  });
		companyGrid.on('click', function(ev) {
		    const clickedRowKey = ev.rowKey; // 클릭된 행의 키
		    const clickedData = companyGrid.getRow(clickedRowKey); // 클릭된 행의 데이터
		    // '주문 정보' 섹션의 입력 필드에 값 설정
		    document.getElementById('companyCode').value = clickedData.companyCode;
		    document.getElementById('company').value = clickedData.companyName;
		    document.getElementById('companyCharger').value = clickedData.companyCharger;
		    document.getElementById('companyTel').value = clickedData.companyPhone;
		    // 모달 닫기
		    $('#companyCodeModal').modal('hide');
		});
	</script>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary"
					data-bs-dismiss="modal">닫기</button>
			</div>
		</div>
	</div>
</div>
<!-- 업체코드 모달 끝 -->
<script>
  // 업체코드 모달 열기
  function showCompanyCodeModal() {
	  $('#companyCodeModal').modal('show');
  }
  window.onload = function() {
      document.getElementById('charger').value = '[[${name}]]';
      document.getElementById('empCode').value = '[[${code}]]';
/*       document.getElementById('productOrderCode').value = '[[${getOrderCode}]]'; */
      
      
      // 오늘 날짜 자동 입력하기
      var today = new Date();
      var year = today.getFullYear();
      var month = (today.getMonth() + 1).toString().padStart(2, '0');
      var day = today.getDate().toString().padStart(2, '0');
      var dateString = year + '-' + month + '-' + day;
      
      // 주문일 input에 오늘 날짜 기본값 설정
      document.getElementById('orderDate').value = dateString;
  };
  
  
	// 제품 모달 검색 함수
	function searchProductList() {
      const productCode = document.querySelector('#searchProductCode').value;
      const productName = document.querySelector('#searchProductName').value;
      
      const filteredData = productList.filter(item => {
          return (!productCode || item.productCode.includes(productCode)) &&
                 (!productName || item.productName.includes(productName));
      });

	    // 필터링된 데이터를 다시 설정
	    grid2.resetData(filteredData);
	}

	// 검색 엔터 이벤트 추가
	document.querySelectorAll(".card-body input").forEach((ele) => {
	    ele.addEventListener('keydown', (event) => {				
	        if (event.keyCode === 13) {
	        	searchProductList();
	        }
	    });
	});

	// 검색 조건 초기화 함수
	function resetCondition() {
/* 	    document.querySelectorAll('.card-body input').forEach((e) => {
	        e.value = null;
	    }); */
	    document.getElementById('searchProductCode').value = '';
	    document.getElementById('searchProductName').value = '';
	    searchProductList();
	}
	
	// 업체 모달 검색 함수
	function searchCompanyList() {
      const companyCode = document.querySelector('#searchCompanyCode').value;
      const companyName = document.querySelector('#searchCompanyName').value;
      
      const filteredData = companyList.filter(item => {
          return (!companyCode || item.companyCode.includes(companyCode)) &&
                 (!companyName || item.companyName.includes(companyName));
      });

	    // 필터링된 데이터를 다시 설정
	    companyGrid.resetData(filteredData);
	}

	// 검색 엔터 이벤트 추가
	document.querySelectorAll(".card-body input").forEach((ele) => {
	    ele.addEventListener('keydown', (event) => {				
	        if (event.keyCode === 13) {
	        	searchCompanyList();
	        }
	    });
	});

	// 검색 조건 초기화 함수
	function resetCompanyCondition() {
/* 	    document.querySelectorAll('.card-body input').forEach((e) => {
	        e.value = null;
	    }); */
	    document.getElementById('searchCompanyCode').value = '';
	    document.getElementById('searchCompanyName').value = '';
	    searchCompanyList();
	}
	
	// 숫자에 콤마 추가 함수
	function formatNumberWithComma(number) {
	    return number.toLocaleString(); // 숫자에 콤마 추가
	}
</script>

<style>
.modal {
	display: block !important; /* Bootstrap 기본 동작 우회 */
	visibility: hidden;
}

.modal.show {
	visibility: visible;
}

.regibtn {
	text-align: right;
}

/* 헤더 체크박스 */
#grid .tui-grid-cell input[type="checkbox"]:hover {
	cursor: pointer;
}

.toastui-chart-tooltip-category {
	width: 100px !important;
}

input[readonly] {
	background-color: white !important; /* 배경색을 흰색으로 변경 */
}

td {
    padding: 0 20px !important;
}

.tui-grid-layer-state {
    z-index: 0;
}
</style>
</html>